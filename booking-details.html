<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約憑證</title>
    <!-- 載入共用設定檔 -->
    <script src="config.js"></script>
    <!-- 載入 Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 新增：載入 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 新增：載入共用 UI 元件 -->
    <script src="ui-components.js"></script>
    <!-- 新增：載入 Google Material Symbols 圖示庫 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- 載入 QRCode.js 函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* --- 全局樣式 --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            background-color: #212529; 
            color: #e0e0e0; 
            padding: 30px 20px; /* 加上您想要的上下間距 */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- 主要容器 --- */
        .container {
            width: 100%;
            max-width: 480px; /* 控制在手機上舒適的寬度 */
        }

        /* --- 票券卡片設計 --- */
        .ticket-card {
            background-color: #343a40;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 24px;
            /* 新增：加粗的上邊框，並設定相對定位 */
            border-top: 40px solid #495057;
            position: relative;
        }

        .ticket-main {
            padding: 24px;
        }

        .ticket-header {
            /* 修改：將標題移至邊框中央 */
            position: absolute;
            top: -34px; /* 修正：向上移動到邊框的中心 */
            left: 50%;
            transform: translateX(-50%); /* 僅需水平置中 */
            background-color: #4a5058; /* 與卡片背景色相同，製造嵌入效果 */
            padding: 0 15px; /* 左右留白，避免文字貼邊 */
            width: auto; /* 讓寬度由內容決定 */
            white-space: nowrap; /* 防止文字換行 */

            z-index: 1; /* 新增：確保標題在最上層 */
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0; /* 移除 margin */
        }

        .service-info h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin: 0 0 16px 0;
        }

        .service-details {
            font-size: 1rem;
            color: #e0e0e0;
        }
        
        .service-details p {
            /* 移除 margin，改由 flex gap 控制間距 */
            margin: 0;
            display: flex;
            align-items: center;
            /* 新增：控制日期和時間之間的間距 */
            gap: 16px; 
        }

        .service-details .icon {
            /* 調整為 MDI 圖示的樣式 */
            margin-right: 8px;
            font-size: 1.3rem;
            vertical-align: middle; /* 確保圖示與文字垂直對齊 */
        }

        /* 新增：放大日期與時間的字體 */
        .service-details strong {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* --- 分隔線 --- */
        .separator {
            border-top: 2px dashed #495057;
            margin: 24px 0;
        }

        /* --- 掃描核銷區 --- */
        .scan-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .qr-code-wrapper {
            flex-shrink: 0;
            background-color: white; /* 讓 QR Code 背景是白色 */
            padding: 8px;
            border-radius: 8px;
            cursor: pointer; /* 新增：提示可以點擊 */
            transition: transform 0.2s;
        }

        .qr-code-wrapper:hover {
            transform: scale(1.05);
        }

        #qrcode {
            display: flex; /* 使用 flex 置中 */
            justify-content: center;
            align-items: center;
        }

        .booking-id-info {
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        .booking-id-info strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-top: 4px;
            word-break: break-all;
        }
        
        .scan-hint {
            font-size: 0.8rem;
            color: #8e8e93;
            margin-top: 8px;
        }

        /* --- 額外資訊區 --- */
        .details-section {
            background-color: #343a40;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .details-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 1px solid #495057;
            padding-bottom: 8px;
            margin: 0 0 16px 0;
        }

        .details-section p, .details-section li {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #e0e0e0;
        }
        
        .details-section ul {
            padding-left: 20px;
            margin: 0;
        }

        .details-section .section-block {
            margin-bottom: 24px;
        }
        .details-section .section-block:last-child {
            margin-bottom: 0;
        }

        .loader, .error {
             text-align: center; 
             font-size: 1.1em; 
             color: #6c757d; 
             padding: 2em; 
        }
        .error { color: #dc3545; }

        /* --- 新增：QR Code 放大 Modal 樣式 --- */
        .qr-modal-overlay {
            display: none; /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .qr-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        #qrcode-large {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .qr-modal-content p {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: #000;
            word-break: break-all;
        }

        /* --- 新增：按鈕樣式 --- */
        .btn {
            border: none;
            border-radius: 8px;
            padding: 0.8rem 0.8rem;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            transition: background-color 0.2s, transform 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-secondary { background-color: #495057; color: #ffffff; }
        .btn-secondary:hover { background-color: #5a6268; }

        .button-group-split {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 24px;
        }
        .button-group-split .btn {
            flex: 1;
        }
    </style>
</head>
<body>

    <div id="page-content">
        <p class="loader">正在載入預約憑證...</p>
    </div>

    <!-- 新增：QR Code 放大顯示的 Modal -->
    <div id="qr-modal" class="qr-modal-overlay">
        <div class="qr-modal-content">
            <div id="qrcode-large"></div>
            <p id="qr-modal-booking-id"></p>
        </div>
    </div>

    <script>
        // --- 從 config.js 讀取設定並建立 Supabase Client ---
        const { createClient } = supabase;
        const supabaseClient = createClient(AppConfig.SUPABASE_URL, AppConfig.SUPABASE_ANON_KEY);

        window.addEventListener('DOMContentLoaded', main);

        async function main() {
            const container = document.getElementById('page-content');
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('id');
            const debugMode = urlParams.get('debug') === 'true';

            // 渲染共用的頁首和頁尾
            renderHeaderAndFooter();

            if (!bookingId) {
                container.innerHTML = `<p class="error">錯誤：未提供預約編號。</p>`;
                return;
            }

            let userProfile = null;

            try {
                // 新增：初始化 LIFF 並檢查登入狀態
                // 終極修正：明確提供 redirectUri，強制 LIFF SDK 以當前頁面為基準，
                // 徹底消除因多頁面跳轉產生的 "not related to the endpoint URL" 警告。
                await liff.init({ liffId: AppConfig.LIFF_ID, redirectUri: window.location.href });

                // 修正：調整判斷順序，優先處理 debug 模式
                if (debugMode && !liff.isInClient()) {
                    // 開發模式，使用假資料
                    console.log('進入開發模式 (非 LINE 環境 + debug=true)');
                    userProfile = {
                        userId: 'U_DEV_000000000000000000000000001',
                        displayName: '開發者AA',
                    };
                } else if (!liff.isLoggedIn()) {
                    // 非開發模式且未登入，導向登入頁
                    console.log('未登入，準備導向 LINE 登入頁...');
                    liff.login({ redirectUri: window.location.href });
                    return; // liff.login() 會跳轉頁面，此處 return 避免後續程式碼執行
                } else {
                    // 已登入，取得使用者資料
                    userProfile = await liff.getProfile();
                }

                // TODO (安全性強化): 在這裡加入檢查，確認 liff.getProfile().userId 是否與預約紀錄中的 line_user_id 相符。
                // 如果不符，就顯示錯誤訊息，不執行後續的資料查詢。

                // --- 從 Supabase 讀取資料 ---
                // 修正：不再直接查詢 bookings 表，改為呼叫安全的 RPC 函式
                const { data: rpcData, error } = await supabaseClient
                    .rpc('get_booking_details_for_user', {
                        p_booking_id: bookingId,
                        p_user_id: userProfile.userId
                    })
                    .single(); // .single() 會直接回傳單一物件

                if (error) throw error;

                // 為了與舊的 renderDetails 函式相容，我們手動重組一下資料結構
                const data = mapRpcDataToLegacyStructure(rpcData);

                renderDetails(data);

            } catch (error) {
                console.error('載入預約詳情時發生錯誤:', error);
                container.innerHTML = `<p class="error">無法載入預約資料。<br>可能是預約不存在，或您沒有權限查看此憑證。</p>`;
            }
        }

        /**
         * 新增：輔助函式，將新的 RPC 回傳結果轉換為舊的巢狀結構，以利 renderDetails 函式重複使用。
         */
        function mapRpcDataToLegacyStructure(rpcData) {
            return {
                booking_id: rpcData.booking_id,
                status: rpcData.status,
                classes: {
                    class_date: rpcData.class_date,
                    start_time: rpcData.start_time,
                    courses: {
                        course_name: rpcData.course_name
                    },
                    coaches: {
                        coach_name: rpcData.coach_name
                    }
                },
                users: {
                    line_display_name: rpcData.line_display_name
                }
            };
        }

        function renderDetails(data) {
            const container = document.getElementById('page-content');
            
            // 從原始資料解構並格式化
            const {
                booking_id,
                status,
                classes: {
                    class_date,
                    start_time,
                    courses: { course_name },
                    coaches: { coach_name }
                },
                users: { line_display_name }
            } = data;

            const dateParts = class_date.split('-');
            const formattedDate = `${dateParts[0]} / ${dateParts[1]} / ${dateParts[2]}`;
            const classTime = start_time.substring(0, 5);

            // 根據預約狀態，產生不同的狀態顯示文字
            let statusText;
            if (status && (status.trim() === '已扣款' || status.trim() === '已付款')) {
                statusText = '已付款';
            } else if (status && status.trim() === '已預約') {
                statusText = '待付款';
            } else {
                statusText = status;
            }

            // 完整的頁面 HTML
            container.innerHTML = `
                <div class="container">
                    <!-- 主要票券卡片 -->
                    <div class="ticket-card">
                        <div class="ticket-header">
                            預約憑證
                        </div>
                        <div class="ticket-main">
                            <div class="service-info">
                                <h2>${course_name}</h2>
                                <div class="service-details">
                                    <p>
                                        <span><span class="icon material-symbols-outlined">calendar_month</span> <strong>${formattedDate}</strong></span>
                                        <span><span class="icon material-symbols-outlined">schedule</span> <strong>${classTime}</strong></span>
                                    </p>
                                </div>
                            </div>

                            <div class="separator"></div>

                            <div class="scan-section">
                                <div class="qr-code-wrapper" id="qr-code-clickable">
                                    <div id="qrcode"></div>
                                </div>
                                <div class="booking-id-info">
                                    預約編號
                                    <strong>${booking_id}</strong>
                                    <p class="scan-hint">請出示此區塊供店家掃描</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 其他詳細資訊 -->
                    <div class="details-section">
                        <div class="section-block">
                            <h3>預約詳情</h3>
                            <ul>
                                <li>預約狀態 : ${statusText}</li>
                                <li>預約學員 : ${line_display_name}</li>
                                <li>指導教練 : ${coach_name}</li>
                            </ul>
                        </div>

                        <div class="section-block">
                            <h3>重要須知</h3>
                            <ul>
                                <li>請提前10分鐘抵達，為您的服務做準備。</li>
                                <li><strong>取消方式</strong>: 如需取消，請回到我們的LINE官方帳號，點擊圖文選單中的「取消預約」功能。</li>
                            </ul>
                        </div>
                    </div>

                    <!-- 新增：底部按鈕區 -->
                    <div class="button-group-split">
                        <button id="back-btn" class="btn btn-secondary">
                            <span class="material-symbols-outlined">arrow_back</span>
                            上一頁
                        </button>
                        <button id="close-btn" class="btn btn-secondary">
                            <span class="material-symbols-outlined">close</span>
                            關閉
                        </button>
                    </div>
                </div>
            `;

            // 產生 QR Code
            new QRCode(document.getElementById("qrcode"), {
                text: booking_id,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // --- 新增：綁定點擊放大 QR Code 的事件 ---
            const qrClickable = document.getElementById('qr-code-clickable');
            const qrModal = document.getElementById('qr-modal');
            
            qrClickable.addEventListener('click', () => {
                const largeQrContainer = document.getElementById('qrcode-large');
                largeQrContainer.innerHTML = ''; // 清空舊的 QR Code

                // 產生一個較大的 QR Code
                new QRCode(largeQrContainer, {
                    text: booking_id,
                    width: 250,
                    height: 250,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                document.getElementById('qr-modal-booking-id').textContent = booking_id;
                qrModal.style.display = 'flex';
            });

            // 點擊黑色背景區域關閉 Modal
            qrModal.addEventListener('click', (event) => {
                if (event.target === qrModal) {
                    qrModal.style.display = 'none';
                }
            });

            // --- 新增：綁定底部按鈕事件 ---
            const backBtn = document.getElementById('back-btn');
            const closeBtn = document.getElementById('close-btn');
            const urlParams = new URLSearchParams(window.location.search);

            backBtn.addEventListener('click', () => {
                window.history.back();
            });

            closeBtn.addEventListener('click', () => {
                // 嘗試使用 LIFF 的關閉視窗功能
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    // 如果不在 LIFF 環境，則提供提示
                    alert('此功能僅在 LINE App 中有效。');
                    // 作為備用，如果 history 中沒有上一頁，可以導向課程頁面
                    if (window.history.length <= 1) {
                        const debugParam = urlParams.get('debug') === 'true' ? '?debug=true' : '';
                        window.location.href = `courses.html${debugParam}`;
                    }
                }
            });
        }
    </script>

</body>
</html>