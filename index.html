<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WALLY 自由教練工作室 - 首頁</title>
    <style>
        :root {
            /* --- 主題色 --- */
            --theme-yellow: #fcc419;
            --theme-yellow-hover: #ffd43b;
            --text-on-yellow: #212529;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            background-color: #212529;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100dvh; /* 使用動態可視高度，解決手機瀏覽器捲軸問題 */
            overflow: hidden; /* 隱藏所有溢出的內容，移除捲軸 */
        }

        .social-icon {
            color: #ffffff;
            text-decoration: none;
            transition: transform 0.2s, color 0.2s;
            display: inline-block; /* 讓 transform 生效 */
        }
        .social-icon:hover {
            transform: scale(1.1);
            color: var(--theme-yellow); /* 滑鼠懸停時變為主題黃色 */
        }
        .social-icon svg {
            width: 28px; /* 設定圖示大小 */
            height: 28px;
        }

        .hero { 
            position: relative;
            overflow: hidden; /* 關鍵：隱藏模糊效果的邊緣 */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }

        /* 新增：使用偽元素來專門處理背景圖和模糊效果 */
        .hero::before {
            content: '';
            position: absolute;
            top: -10px; right: -10px; bottom: -10px; left: -10px; /* 放大偽元素以避免模糊邊緣 */
            z-index: 1;
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('images/cover.jpeg');
            background-size: cover;
            background-position: center;
            filter: blur(3px); /* 加上模糊效果 */
        }

        .hero > * {
            position: relative; /* 確保內容在遮罩之上 */
            z-index: 2;
        }

        h1 {
            color: #ffffff;
            font-size: 3rem; /* 恢復原來的字體大小 */
            margin: 0 0 0.5rem 0;
            font-weight: 700;
        }

        p {
            color: #b0b0b0;
            font-size: 1.25rem;
            margin-bottom: 2rem;
        }

        /* 新增：主按鈕下方的社群圖示容器 */
        .social-links {
            margin-top: 2.5rem; /* 與上方按鈕的間距 */
            display: flex;
            gap: 1.5rem; /* 圖示之間的間距 */
            align-items: center;
        }

        /* 新增：獨立的分隔線樣式 */
        .separator {
            width: 1px;
            background-color: rgba(255, 255, 255, 0.5); /* 使用半透明白色 */
            height: 24px; /* 讓分隔線與圖示同高 */
        }
        .btn {
            display: inline-block;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { 
            background-color: var(--theme-yellow); /* 使用主題黃色 */
            color: var(--text-on-yellow);
        }

        .btn-primary:hover {
            background-color: var(--theme-yellow-hover); /* 滑鼠懸停時的亮黃色 */
        }

        /* 新增：放在圖片左下角的聯絡資訊 */
        .contact-info {
            position: absolute;
            bottom: 1.5rem;
            left: 50%; /* 水平置中第一步：移到 50% 位置 */
            transform: translateX(-50%); /* 水平置中第二步：向左移自身寬度的一半 */
            width: 90%; /* 增加寬度以避免文字換行 */
            z-index: 2;
            text-align: center; /* 文字水平置中 */
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6; /* 調整行高以增加可讀性 */
        }
        .contact-info p {
            margin: 0; /* 覆蓋 p 的預設樣式 */
        }

        .desktop-only-space {
            display: inline; /* 或不寫，因為 span 預設就是 inline */
        }
        
        .mobile-only-break {
            display: none; /* 在桌面版預設隱藏 */
        }
        
        /* 響應式設計：在小螢幕上調整字體大小 */
        @media (max-width: 600px) {
            h1 {
                font-size: 2.5rem; /* 恢復手機版的字體大小 */
            }
            p {
                font-size: 1.1rem;
            }
            .btn {
                padding: 0.8rem 2rem;
                font-size: 1.1rem;
            }
            .social-icon svg {
                width: 24px;
                height: 24px;
            }
            .contact-info {
                font-size: 0.75rem;
                bottom: 1rem;
            }
            .desktop-only-space {
                display: none; /* 在手機版隱藏這個空格 */
            }
            .mobile-only-break {
                display: block; /* 在手機版顯示為區塊元素，強制換行 */
            }
        }
    </style>
</head>
<body>
    <main class="hero">
        <h1>WALLY<span class="desktop-only-space"> </span><br class="mobile-only-break">自由教練工作室</h1>
        <p>打造理想體態，從這裡開始。</p>
        <!-- 關鍵修正：移除預設的 href，避免 LIFF SDK 在初始化時掃描到並產生警告。
             href 將完全由下方的 JavaScript 動態設定。
             設定 href="javascript:void(0);" 是一個安全的做法，表示點擊後不執行任何操作。 -->
        <a href="javascript:void(0);" class="btn btn-primary">立即預約課程</a>
        <div class="social-links">
            <a href="https://www.threads.net/@freecoachwally" target="_blank" rel="noopener noreferrer" class="social-icon" title="前往 Threads">
                <!-- 更換為 @ 符號圖示 -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path>
                </svg>
            </a>
            <a href="https://www.instagram.com/freecoachwally/" target="_blank" rel="noopener noreferrer" class="social-icon" title="前往 Instagram">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                </svg>
            </a>
            <div class="separator"></div>
            <!-- 新增：管理者登入圖示 -->
            <a href="manager.html" class="social-icon" title="管理者後台">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>
                </svg>
            </a>
        </div>
        <div class="contact-info">
            <p>0937-402-893</p>
            <p>新竹市中華路二段 625 號 2 樓</p>
        </div>
    </main>

    <!-- 載入共用設定檔 -->
    <script src="config.js"></script>
    <!-- 載入 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        /**
         * 整合後的 LIFF 初始化與路由函式
         * 1. 初始化 LIFF。
         * 2. 檢查 liff.state，如果存在，則跳轉到目標頁面 (例如從 LINE Bot 點擊憑證連結)。
         * 3. 如果不存在 liff.state，則正常顯示首頁，並根據環境 (LINE App 或外部瀏覽器) 設定「立即預約」按鈕的正確連結。
         */
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            const bookingLink = document.querySelector('a.btn-primary');

            try {
                await liff.init({ liffId: AppConfig.LIFF_ID, redirectUri: window.location.href });
                console.log('LIFF initialized on index.html');

                // 手動從 URL 參數中取得 liff.state 的值
                const manualLiffState = urlParams.get('liff.state');

                if (manualLiffState) {
                    // --- 情況 1: 有 liff.state，執行跳轉 ---
                    const baseUrl = window.location.origin + window.location.pathname.replace(/index\.html$/, '');
                    // 從 liff.state 的值中分離出路徑和它自帶的參數
                    const [path, paramsInState] = manualLiffState.split('?');
                    // 重新組合所有參數
                    const allParams = new URLSearchParams();
                    if (paramsInState) {
                        new URLSearchParams(paramsInState).forEach((value, key) => allParams.append(key, value));
                    }
                    urlParams.forEach((value, key) => {
                        if (key !== 'liff.state') {
                            allParams.append(key, value);
                        }
                    });
                    const finalQueryString = allParams.toString();
                    const debugQuery = debugMode ? (finalQueryString ? '&debug=true' : '?debug=true') : '';
                    const finalPath = `${path}?${finalQueryString}${debugQuery}`;
                    window.location.replace(baseUrl + finalPath);
                } else {
                    // --- 情況 2: 沒有 liff.state，正常處理首頁邏輯 ---

                    // 檢查 URL 是否包含 'code'，這表示剛從 LINE OAuth 登入跳轉回來
                    if (urlParams.has('code') && liff.isLoggedIn()) {
                        console.log('Logged in on callback, redirecting to courses.html');
                        const coursesPageUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}courses.html${debugMode ? '?debug=true' : ''}`;
                        window.location.href = coursesPageUrl;
                        return; // 中斷後續執行
                    }

                    // 綁定按鈕點擊事件，在點擊時才執行登入或跳轉
                    bookingLink.addEventListener('click', (e) => {
                        e.preventDefault(); // 防止預設的跳轉行為
                        handleBookingClick(debugMode);
                    });
                }
            } catch (error) {
                console.error('Error processing LIFF state on index.html:', error);
                const debugQuery = debugMode ? '?debug=true' : '';
                bookingLink.href = `courses.html${debugQuery}`;
            }

            async function handleBookingClick(debugMode) {
                const debugQuery = debugMode ? '?debug=true' : '';
                const coursesPageUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}courses.html${debugQuery}`;

                if (!liff.isLoggedIn()) {
                    // 如果未登入，呼叫 liff.login() 並將 courses.html 設為最終的 redirectUri
                    // 關鍵修正：在 PC 端，redirectUri 應該是當前頁面 (index.html)，
                    // LIFF 會使用 liff.state 來記住最終要跳轉的目的地。
                    const loginRedirectUri = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}`;
                    console.log('User not logged in. Redirecting to login with courses.html as final destination.');
                    liff.login({ redirectUri: loginRedirectUri });
                } else {
                    // 如果已登入，直接跳轉到 courses.html
                    console.log('User already logged in. Redirecting to courses.html.');
                    window.location.href = coursesPageUrl;
                }
            }
        });
    </script>
</body>
</html>
