<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程預約</title>
    <!-- 載入 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 載入共用設定檔 -->
    <script src="config.js"></script>
    <!-- 方案一：載入 Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 10px;
            background-color: #212529; /* 1. 調整為較柔和的深灰色 */
            color: #e0e0e0; /* 1. 預設淺色文字 */
        }
        #header-container { margin-bottom: 1.5em; }
        #header-container p { margin: 0; font-size: 1.1em; color: #e0e0e0; }
        
        .course-grid {
            display: grid;
            grid-template-columns: 1fr; /* 手機上預設單欄 */
            gap: 10px;
        }
        .course-card {
            background-color: #343a40; /* 1. 調整為較淺的卡片背景 */
            border-radius: 8px;
            overflow: hidden; /* 讓圖片的圓角生效 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s; /* 修改 transition 效果 */
            display: flex;
            flex-direction: row; /* 改為水平排列 */
            align-items: center; /* 垂直置中 */
            height: 140px; /* 3. 卡片的高度是 140 */
            /* padding-left: 10px;  */
        }
        .course-card:hover {
            background-color: #495057; /* 改變背景顏色 */
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .course-card img {
            width: 120px; /* 2. 我希望圖片是120x120 */
            height: 120px; /* 2. 我希望圖片是120x120 */
            object-fit: cover; /* 讓圖片不變形地填滿容器 */
            flex-shrink: 0; /* 防止圖片被壓縮 */
            border-radius: 4px; /* 圖片圓角 */
            margin-left: 10px;
        }
        .course-card-content {
            display: flex;
            flex-direction: column;
            justify-content: center; /* 6. 圖片右側的文字，整個區塊上下置中 */
            padding: 0 1rem; /* 調整左右內距 */
            gap: 0.25rem; /* 增加文字行之間的間距 */
            text-align: left; /* 文字靠左 */
            flex-grow: 1; /* 佔滿剩餘空間 */
            overflow: hidden; /* 為了讓文字截斷生效 */
        }
        .course-card h2 { 
            margin: 0; /* 移除所有外部間距 */
            color: #ffffff; /* 1. 標題亮白色 */
        }
        .course-card .description { 
            margin: 0; /* 移除所有外部間距 */
            color: #b0b0b0; /* 1. 描述文字淺灰色 */
            font-size: 0.9em;
            /* 3. 處理文字過多，最多顯示兩行 */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .course-card .price {
            margin: 0; /* 移除所有外部間距 */
            font-weight: bold;
            color: #4dabf7; /* 1. 價格亮藍色 */
            font-size: 1.1em;
        }
        .loader, .error { text-align: center; font-size: 1.1em; color: #6c757d; padding: 2em; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <!-- 新增一個獨立的頁首容器 -->
    <div id="header-container">
        <!-- 標題和使用者資訊將會顯示在這裡 -->
    </div>
    
    <div id="content-container">
        <p class="loader">正在初始化並載入課程資料...</p>
    </div>

    <script>
        // --- 從 config.js 讀取設定 ---
        const { createClient } = supabase; // 從全域 supabase 物件中解構出 createClient 方法
        const supabaseClient = createClient(AppConfig.SUPABASE_URL, AppConfig.SUPABASE_ANON_KEY); // 建立客戶端實例

        // --- 舊版 GAS 設定 (保留備用) ---
        // const DEV_GAS_URL = 'https://script.google.com/macros/s/AKfycbzsR-H8MM9LLrAxeHPK97qJtLNL-YweksnKpA6Io14RyOrZ8NENTQ7uZ3Bd2ng6Ht3G/exec';
        // const PROD_GAS_URL = '<?= ScriptApp.getService().getUrl() ?>';
        // const GAS_URL = PROD_GAS_URL.startsWith('http') ? PROD_GAS_URL : DEV_GAS_URL;

     
        // 全域變數，用來存放使用者資訊
        let userProfile = null;

        async function main() {
            const headerContainer = document.getElementById('header-container');
            const contentContainer = document.getElementById('content-container');

            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            console.log('Debug mode:', debugMode);

            try {
                // 步驟 1: 無論如何都先初始化 LIFF
                await liff.init({ liffId: AppConfig.LIFF_ID_COURSES });
                console.log('LIFF initialized');

                let welcomeName = '';

                // 步驟 2: 判斷是否登入
                if (liff.isLoggedIn()) {
                    // 已登入，取得使用者資料
                    userProfile = await liff.getProfile();
                    welcomeName = userProfile.displayName;
                    console.log('LIFF 登入成功，welcomeName 設為:', welcomeName);
                } else if (debugMode && !liff.isInClient()) {
                    // 未登入，但處於開發模式
                    welcomeName = '小明';
                    console.log('未登入，進入開發模式 (非 LINE 環境 + debug=true)，welcomeName 設為:', welcomeName);
                } else {
                    // 未登入，且非開發模式，導向登入頁
                    console.log('未登入，準備導向 LINE 登入頁...');
                    liff.login();
                    return; // liff.login() 會跳轉頁面，此處 return 避免後續程式碼執行
                }
                headerContainer.innerHTML = `<p>歡迎 ${welcomeName}，請點選喜愛的課程：</p>`;
                await fetchCourses();
            } catch (err) {
             console.error('初始化失敗', err);
                headerContainer.innerHTML = '<h1>錯誤</h1>';
                contentContainer.innerHTML = '<p class="error">初始化失敗，請確認您是在 LINE App 中開啟此頁面，或檢查 LIFF ID 是否正確。</p>';
            }
        }
        
        main();

         async function fetchCourses() {
            const container = document.getElementById('content-container');
            container.innerHTML = '<p class="loader">課程資料載入中...</p>';
            console.log('開始 fetchCourses...');

            try {                
                // --- 方案一：直接從 Supabase 讀取資料 ---
                console.log('正在從 Supabase 查詢 active courses...');
             const { data, error } = await supabaseClient
                    .from('courses') // 注意：資料表名稱是小寫
                    .select('*')
                    .eq('status', 'Active')
                    .order('course_id', { ascending: true }); // 新增：依照 course_id 升序排列

                if (error) {
                    console.error('Supabase 查詢錯誤:', error);
                    throw error;
                }
                console.log('成功從 Supabase 取得資料:', data);
                
                if (data && data.length > 0) {
                    renderCourses(data);
                } else {
                    console.log('Supabase 回傳成功，但沒有 active 的課程。');
                    container.innerHTML = '<p>目前沒有可用的課程。</p>';
                }
            } catch (error) {
                console.error('讀取課程資料時發生嚴重錯誤:', error);
                container.innerHTML = `<p class="error">載入課程失敗，請開啟開發者工具(F12)查看 Console 中的詳細錯誤訊息。<br><br>錯誤: ${error.message}</p>`;
            }
        }
        
        function renderCourses(courses) {
            const container = document.getElementById('content-container');
            let html = '<div class="course-grid">';
            courses.forEach(course => {
                // 組合出完整的圖片 URL
                const imageUrl = course.image_url ? `${AppConfig.IMAGE_BASE_URL}${course.image_url}` : 'https://via.placeholder.com/400x180.png?text=No+Image';
                html += `
                    <div class="course-card" onclick="selectCourse('${course.course_id}', '${encodeURIComponent(course.course_name)}')">
                        <img src="${imageUrl}" alt="${course.course_name}" width="120" height="120" loading="lazy">
                        <div class="course-card-content">
                            <h2>${course.course_name}</h2>
                            <p class="description">${course.short_description || ''}</p>
                            <p class="price">每小時 $${course.price}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        function selectCourse(courseId, courseName) {
            // 傳遞 course_id 用於查詢，course_name 用於顯示標題
            const urlParams = new URLSearchParams(window.location.search);
            //如果網址有帶debug=true, 則 schedule.html?id=${courseId}&name=${courseName}&debug=true
            const debugParam = urlParams.get('debug') === 'true' ? '&debug=true' : '';
            window.location.href = `schedule.html?id=${courseId}&name=${courseName}${debugParam}`;
        }
        
    </script>



</body>
</html>
