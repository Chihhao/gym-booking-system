<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程預約</title>
    <!-- 載入 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 載入共用設定檔 -->
    <script src="config.js"></script>
    <!-- 方案一：載入 Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 新增：載入共用樣式表 -->
    <link rel="stylesheet" href="common.css">
    <!-- 新增：載入共用 UI 元件 -->
    <script src="ui-components.js"></script>
    <!-- 新增：載入 Google Material Symbols 圖示庫 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #212529; /* 1. 調整為較柔和的深灰色 */
            color: #e0e0e0;
            /* padding: 40px 0;  由 main-container 控制 */
            display: flex;
            justify-content: center; /* 水平置中 .main-container */
        }
        /* 移除已移至 common.css 的卡片樣式 */
        .loader, .error { text-align: center; font-size: 1.1em; color: #6c757d; padding: 2em; }
        .error { color: #dc3545; }

    </style>
</head>
<body>
    <!-- 新增：使用通用容器包裹所有內容 -->
    <div class="main-container">
        <div id="header-container"></div>
        <div id="content-container"><p class="loader">正在初始化並載入課程資料...</p></div>
    </div>

    <script>
        // --- 從 config.js 讀取設定 ---
        const { createClient } = supabase; // 從全域 supabase 物件中解構出 createClient 方法
        const supabaseClient = createClient(AppConfig.SUPABASE_URL, AppConfig.SUPABASE_ANON_KEY); // 建立客戶端實例

        // --- 舊版 GAS 設定 (保留備用) ---
        // const DEV_GAS_URL = 'https://script.google.com/macros/s/AKfycbzsR-H8MM9LLrAxeHPK97qJtLNL-YweksnKpA6Io14RyOrZ8NENTQ7uZ3Bd2ng6Ht3G/exec';
        // const PROD_GAS_URL = '<?= ScriptApp.getService().getUrl() ?>';
        // const GAS_URL = PROD_GAS_URL.startsWith('http') ? PROD_GAS_URL : DEV_GAS_URL;

     
        // 全域變數，用來存放使用者資訊
        let userProfile = null;

        async function main() {
            const headerContainer = document.getElementById('header-container');
            const contentContainer = document.getElementById('content-container');

            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            console.log('Debug mode:', debugMode);

            // 渲染共用的頁首和頁尾
            renderHeaderAndFooter();

            try {
                // 步驟 1: 無論如何都先初始化 LIFF
                // 關鍵修正：加入 withLogin: false，以避免在跳轉到下一頁 (coaches.html) 時產生 URL 不匹配的警告。
                // 這會將此頁面設為新的基準 URL。
                await liff.init({ liffId: AppConfig.LIFF_ID, withLogin: false });
                console.log('LIFF initialized');

                // 修正：將 userProfile 的宣告移至此處
                userProfile = null;

                // 步驟 2: 判斷是否登入
                if (debugMode && !liff.isInClient()) {
                    // 優先處理開發模式：無論 LIFF 是否登入，都使用開發者假資料
                    userProfile = {
                        userId: 'U_DEV_000000000000000000000000001',
                        displayName: '開發者AA',
                    };
                    console.log('進入開發模式 (非 LINE 環境 + debug=true)，偽造的使用者資訊:', userProfile);
                } else if (liff.isLoggedIn()) {
                    // 已登入，取得使用者資料
                    userProfile = await liff.getProfile();
                    console.log('LIFF 登入成功，使用者:', userProfile.displayName);
                } else {
                    // 未登入，且非開發模式，導向登入頁
                    console.log('未登入，準備導向 LINE 登入頁...');
                    liff.login({ redirectUri: window.location.href });
                    return; // liff.login() 會跳轉頁面，此處 return 避免後續程式碼執行
                }

                // 移除歡迎訊息，改為顯示流程圖
                headerContainer.innerHTML = `
                    <div class="step-indicator">
                        <div class="step active">
                            <div class="step-box">課程</div>
                        </div>
                        <span class="material-symbols-outlined connector">arrow_forward</span>
                        <div class="step">
                            <div class="step-box">教練</div>
                        </div>
                        <span class="material-symbols-outlined connector">arrow_forward</span>
                        <div class="step">
                            <div class="step-box">時間</div>
                        </div>
                        <span class="material-symbols-outlined connector">arrow_forward</span>
                        <div class="step">
                            <div class="step-box">完成</div>
                        </div>
                    </div>`;
                await fetchCourses();
            } catch (err) {
             console.error('初始化失敗', err);
                headerContainer.innerHTML = '<h1>錯誤</h1>';
                contentContainer.innerHTML = '<p class="error">初始化失敗，請確認您是在 LINE App 中開啟此頁面，或檢查 LIFF ID 是否正確。</p>';
            }
        }
        
        main();

         async function fetchCourses() {
            const container = document.getElementById('content-container');
            container.innerHTML = '<p class="loader">課程資料載入中...</p>';
            console.log('開始 fetchCourses...');

            try {                
                // --- 方案一：直接從 Supabase 讀取資料 ---
                console.log('正在從 Supabase 查詢 active courses...');
             const { data, error } = await supabaseClient
                    .from('courses') // 注意：資料表名稱是小寫
                    .select('*')
                    .eq('status', 'Active')
                    .order('course_id', { ascending: true }); // 新增：依照 course_id 升序排列

                if (error) {
                    console.error('Supabase 查詢錯誤:', error);
                    throw error;
                }
                console.log('成功從 Supabase 取得資料:', data);
                
                if (data && data.length > 0) {
                    renderCourses(data);
                } else {
                    console.log('Supabase 回傳成功，但沒有 active 的課程。');
                    container.innerHTML = '<p>目前沒有可用的課程。</p>';
                }
            } catch (error) {
                console.error('讀取課程資料時發生嚴重錯誤:', error);
                container.innerHTML = `<p class="error">載入課程失敗，請開啟開發者工具(F12)查看 Console 中的詳細錯誤訊息。<br><br>錯誤: ${error.message}</p>`;
            }
        }
        
        function renderCourses(courses) {
            const container = document.getElementById('content-container');
            let html = '<div class="card-grid">';
            courses.forEach(course => {
                // 組合出完整的圖片 URL
                const imageUrl = course.image_url ? `${AppConfig.IMAGE_BASE_URL}${course.image_url}` : 'https://via.placeholder.com/400x180.png?text=No+Image';
                html += `
                    <div class="card" onclick="selectCourse('${course.course_id}', '${encodeURIComponent(course.course_name)}')">
                        <img class="card-image" src="${imageUrl}" alt="${course.course_name}" loading="lazy">
                        <div class="card-content">
                            <h2 class="card-title">${course.course_name}</h2>
                            <p class="card-description">${course.short_description || ''}</p>
                            <p class="card-highlight">每小時 $${course.price}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        function selectCourse(courseId, courseName) {
            // 流程變更：導向到新的教練選擇頁面 (coaches.html)
            const urlParams = new URLSearchParams(window.location.search);
            const debugParam = urlParams.get('debug') === 'true' ? '&debug=true' : '';
            // 將 courseId 和 courseName 傳遞給新的教練選擇頁面
            window.location.href = `coaches.html?courseId=${courseId}&courseName=${encodeURIComponent(courseName)}${debugParam}`;
        }
        
    </script>



</body>
</html>
