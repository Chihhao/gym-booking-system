<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨ç®¡ç† (æ–°ç‰ˆ)</title>
    <!-- è¼‰å…¥å…±ç”¨è¨­å®šæª” -->
    <script src="config.js"></script>
    <!-- è¼‰å…¥ Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #dee2e6;
            --hour-line-color: #e9ecef;
            --time-axis-width: 80px;
            --header-height: 60px;
            --hour-height: 80px; /* æ¯å°æ™‚çš„é«˜åº¦ï¼Œå¯ä»¥èª¿æ•´ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .schedule-container {
            padding: 2rem;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .schedule-controls h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .schedule-header {
            display: flex;
            margin-left: var(--time-axis-width); /* èˆ‡ä¸‹æ–¹æ™‚é–“è»¸å°é½Š */
            border-bottom: 2px solid var(--border-color);
        }

        .day-header {
            flex: 1; /* è®“æ¯å€‹æ—¥æœŸé ­éƒ¨ç­‰å¯¬ */
            text-align: center;
            padding: 0.75rem 0;
            font-weight: 600;
            font-size: 1.1rem;
            border-left: 1px solid var(--border-color);
        }

        .schedule-canvas-grid {
            display: flex;
            position: relative;
            overflow-y: auto; /* å¦‚æœå…§å®¹éå¤šï¼Œå…è¨±å‚ç›´æ²å‹• */
            /* ç¸½é«˜åº¦ = å°æ™‚æ•¸ * æ¯å°æ™‚é«˜åº¦ */
            height: calc(13 * var(--hour-height)); 
        }

        .time-axis {
            width: var(--time-axis-width);
            flex-shrink: 0;
            position: relative;
        }

        .time-label {
            position: absolute;
            right: 8px;
            transform: translateY(-50%); /* è®“æ–‡å­—å‚ç›´ç½®ä¸­æ–¼ç·šä¸Š */
            font-size: 0.9rem;
            color: #6c757d;
        }

        .day-column {
            flex: 1; /* è®“æ¯å€‹æ—¥æœŸæ¬„ä½ç­‰å¯¬ */
            position: relative; /* é—œéµï¼šè¨­å®šç‚ºå­å±¤ class-item çš„å®šä½åƒè€ƒé» */
            border-left: 1px solid var(--border-color);
        }

        .hour-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: var(--hour-line-color);
            left: 0;
        }

        /* é€™æ˜¯æœªä¾†è¦æ”¾ç½®èª²ç¨‹çš„æ¨£å¼ï¼Œå…ˆå®šç¾©å¥½ */
        .class-item {
            position: absolute;
            left: 4px;
            right: 4px;
            background-color: #404040; /* çµ±ä¸€ç‚ºæ·±ç°è‰²åº• */
            color: white;
            border-left: 5px solid var(--border-color); /* é è¨­é‚Šæ¡†ï¼Œæœƒè¢« JS è¦†è“‹ */
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9em;
            box-sizing: border-box;
            overflow: hidden;
            z-index: 10;
        }
        .class-item strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .class-item .info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            background-color: white;
            color: var(--text-color);
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #e9ecef;
        }

    </style>
</head>
<body>

    <div class="schedule-container">
        <div class="schedule-controls">
            <h1>ğŸ—“ï¸ èª²è¡¨ç®¡ç† (ç•«å¸ƒç‰ˆ)</h1>
            <div>
                <button id="prev-week-btn" class="btn">&lt; ä¸Šä¸€é€±</button>
                <span id="week-range-display" style="margin: 0 1rem; font-weight: 500;"></span>
                <button id="next-week-btn" class="btn">ä¸‹ä¸€é€± &gt;</button>
            </div>
        </div>
        
        <!-- æ˜ŸæœŸæ¨™é ­ -->
        <div id="schedule-header-container" class="schedule-header">
            <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
        </div>

        <!-- ä¸»è¦ç•«å¸ƒç¶²æ ¼ -->
        <div id="schedule-canvas-grid" class="schedule-canvas-grid">
            
            <!-- å·¦å´æ™‚é–“è»¸ -->
            <div id="time-axis-container" class="time-axis">
                <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
            </div>

            <!-- æ¯æ—¥ç•«å¸ƒ (7å¤©) -->
            <div id="day-columns-container" style="display: flex; flex-grow: 1;">
                <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
            </div>

        </div>
    </div>

    <script>
        // --- å¾ config.js è®€å–è¨­å®š ---
        const { createClient } = supabase;
        const supabaseClient = createClient(AppConfig.SUPABASE_URL, AppConfig.SUPABASE_ANON_KEY);

        // --- å…¨åŸŸè®Šæ•¸ ---
        const startHour = 9;
        const endHour = 21;
        const hourHeight = 80; // å¿…é ˆèˆ‡ CSS ä¸­çš„ --hour-height è®Šæ•¸ä¸€è‡´
        const pixelsPerMinute = hourHeight / 60;

        let currentDate = new Date(); // ç”¨æ–¼è¿½è¹¤ç›®å‰é¡¯ç¤ºçš„é€±æ¬¡

        document.addEventListener('DOMContentLoaded', () => {
            renderCanvasShell();
            loadSchedule();

            // ç¶å®šé€±æ¬¡åˆ‡æ›æŒ‰éˆ•
            document.getElementById('prev-week-btn').addEventListener('click', () => changeWeek(-7));
            document.getElementById('next-week-btn').addEventListener('click', () => changeWeek(7));
        });

        /**
         * æ¸²æŸ“ç•«å¸ƒçš„éœæ…‹éª¨æ¶ (æ™‚é–“è»¸ã€æ˜ŸæœŸæ¨™é ­ã€ç¶²æ ¼ç·š)
         */
        function renderCanvasShell() {
            const headerContainer = document.getElementById('schedule-header-container');
            const timeAxisContainer = document.getElementById('time-axis-container');
            const dayColumnsContainer = document.getElementById('day-columns-container');

            // --- æ¸²æŸ“å·¦å´æ™‚é–“è»¸ ---
            let timeAxisHtml = '';
            for (let hour = startHour; hour <= endHour; hour++) {
                const topPosition = (hour - startHour) * hourHeight;
                if (hour === startHour) {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px; transform: translateY(0);">${String(hour).padStart(2, '0')}:00</div>`;
                } else {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px;">${String(hour).padStart(2, '0')}:00</div>`;
                }
            }
            timeAxisContainer.innerHTML = timeAxisHtml;

            // --- æ¸²æŸ“æ¯æ—¥ç•«å¸ƒå’Œå°æ™‚æ°´å¹³ç·š ---
            let dayColumnsHtml = '';
            for (let i = 0; i < 7; i++) {
                let dayColumnContent = '';
                for (let hour = startHour + 1; hour <= endHour; hour++) {
                    const topPosition = (hour - startHour) * hourHeight;
                    dayColumnContent += `<div class="hour-line" style="top: ${topPosition}px;"></div>`;
                }
                // ç‚ºæ¯æ—¥ç•«å¸ƒåŠ ä¸Š data-day å±¬æ€§ï¼Œæ–¹ä¾¿å¾ŒçºŒé¸å–
                dayColumnsHtml += `<div class="day-column" data-day="${i}">${dayColumnContent}</div>`;
            }
            dayColumnsContainer.innerHTML = dayColumnsHtml;
        }

        /**
         * è¼‰å…¥ä¸¦æ¸²æŸ“æŒ‡å®šé€±æ¬¡çš„èª²è¡¨
         */
        async function loadSchedule() {
            const startOfWeek = new Date(currentDate);
            const dayOfWeek = startOfWeek.getDay(); // 0=Sun, 1=Mon, ...
            startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek); // å°‡ä¸€é€±é–‹å§‹è¨­ç‚ºæ˜ŸæœŸæ—¥

            const endDate = new Date(startOfWeek);
            endDate.setDate(startOfWeek.getDate() + 6);

            const formatDate = (date) => date.toISOString().split('T')[0];
            const startDateString = formatDate(startOfWeek);
            const endDateString = formatDate(endDate);

            // æ›´æ–°é ‚éƒ¨çš„æ—¥æœŸç¯„åœé¡¯ç¤º
            document.getElementById('week-range-display').textContent = `${startDateString} ~ ${endDateString}`;

            // æ›´æ–°æ˜ŸæœŸæ¨™é ­
            updateDayHeaders(startOfWeek);

            try {
                const { data, error } = await supabaseClient
                    .from('classes_with_details')
                    .select('*')
                    .gte('class_date', startDateString)
                    .lte('class_date', endDateString);

                if (error) throw error;

                renderClasses(data);

            } catch (error) {
                console.error('è¼‰å…¥èª²è¡¨è³‡æ–™å¤±æ•—:', error);
                alert(`è¼‰å…¥èª²è¡¨å¤±æ•—: ${error.message}`);
            }
        }

        /**
         * å°‡èª²ç¨‹è³‡æ–™æ¸²æŸ“åˆ°ç•«å¸ƒä¸Š
         * @param {Array} classes - å¾ Supabase å–å¾—çš„èª²ç¨‹è³‡æ–™é™£åˆ—
         */
        function renderClasses(classes) {
            // 1. æ¸…é™¤æ‰€æœ‰èˆŠçš„èª²ç¨‹é …ç›®
            document.querySelectorAll('.class-item').forEach(item => item.remove());

            // 2. éæ­·æ–°èª²ç¨‹ä¸¦æ¸²æŸ“
            classes.forEach(cls => {
                if (!cls.start_time || !cls.end_time) {
                    console.warn('èª²ç¨‹è³‡æ–™ç¼ºå°‘ start_time æˆ– end_time:', cls);
                    return; // è·³éä¸å®Œæ•´çš„è³‡æ–™
                }

                const classDate = new Date(cls.class_date);
                const dayIndex = classDate.getDay(); // 0=Sun, 6=Sat

                // è¨ˆç®— top
                const [startH, startM] = cls.start_time.split(':').map(Number);
                const totalStartMinutesFrom9AM = (startH - startHour) * 60 + startM;
                const top = totalStartMinutesFrom9AM * pixelsPerMinute;

                // è¨ˆç®— height
                const [endH, endM] = cls.end_time.split(':').map(Number);
                const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
                const height = durationMinutes * pixelsPerMinute;

                // å»ºç«‹èª²ç¨‹ DOM å…ƒç´ 
                const classEl = document.createElement('div');
                classEl.className = 'class-item';
                classEl.style.top = `${top}px`;
                classEl.style.height = `${height}px`;
                // ç›´æ¥ä½¿ç”¨èª²ç¨‹å‹éŒ„çš„é¡è‰²ä½œç‚ºå·¦å´é‚Šæ¡†é¡è‰²
                classEl.style.borderLeftColor = cls.color || '#6c757d';

                classEl.innerHTML = `
                    <strong>${cls.class_name}</strong>
                    <div class="info">${cls.coach_name}</div>
                    <div class="info">${cls.start_time.substring(0, 5)} - ${cls.end_time.substring(0, 5)}</div>
                `;

                // æ‰¾åˆ°å°æ‡‰çš„æ¯æ—¥ç•«å¸ƒä¸¦é™„åŠ èª²ç¨‹
                const dayColumn = document.querySelector(`.day-column[data-day="${dayIndex}"]`);
                if (dayColumn) {
                    dayColumn.appendChild(classEl);
                }
            });
        }

        /**
         * æ›´æ–°æ˜ŸæœŸæ¨™é ­ä»¥é¡¯ç¤ºæ—¥æœŸ
         * @param {Date} startOfWeek - ç•¶é€±çš„æ˜ŸæœŸæ—¥
         */
        function updateDayHeaders(startOfWeek) {
            const headerContainer = document.getElementById('schedule-header-container');
            const days = ['é€±æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let headerHtml = '';
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startOfWeek);
                currentDate.setDate(startOfWeek.getDate() + i);
                headerHtml += `<div class="day-header">${days[i]}<br><span style="font-size: 0.8em; font-weight: 400;">${currentDate.getMonth() + 1}/${currentDate.getDate()}</span></div>`;
            }
            headerContainer.innerHTML = headerHtml;
        }

        /**
         * åˆ‡æ›é€±æ¬¡
         * @param {number} days - è¦ç§»å‹•çš„å¤©æ•¸ (ä¾‹å¦‚ -7 æˆ– 7)
         */
        function changeWeek(days) {
            currentDate.setDate(currentDate.getDate() + days);
            loadSchedule();
        }

    </script>
    <!-- å¼•å…¥ chroma.js ç”¨æ–¼é¡è‰²æ“ä½œ -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script> -->

</body>
</html>