<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨ç®¡ç† (æ–°ç‰ˆ)</title>
    <!-- è¼‰å…¥å…±ç”¨è¨­å®šæª” -->
    <script src="config.js"></script>
    <!-- è¼‰å…¥ Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- æ–°å¢ï¼šè¼‰å…¥å…±ç”¨çš„å¾Œå°å·¥å…·å‡½å¼ -->
    <script src="manager-utils.js"></script>
    <!-- æ–°å¢ï¼šè¼‰å…¥ interact.js ç”¨æ–¼æ‹–æ›³èˆ‡ç¸®æ”¾ -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #dee2e6;
            --hour-line-color: #e9ecef;
            --time-axis-width: 80px;
            --header-height: 60px;
            --hour-height: 80px; /* æ¯å°æ™‚çš„é«˜åº¦ï¼Œå¯ä»¥èª¿æ•´ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 2rem; /* èˆ‡ main-content ä¿æŒä¸€è‡´ */
        }

        .schedule-container {
            padding: 0rem;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .schedule-controls h1 {
            margin: 0;
            font-size: 1.8rem; /* èˆ‡ manager.html çš„ .page-header h1 ä¸€è‡´ */
        }

        .schedule-header {
            display: flex;
            margin-left: var(--time-axis-width); /* èˆ‡ä¸‹æ–¹æ™‚é–“è»¸å°é½Š */
            border-bottom: 2px solid var(--border-color);
        }

        .day-header {
            flex: 1; /* è®“æ¯å€‹æ—¥æœŸé ­éƒ¨ç­‰å¯¬ */
            text-align: center;
            padding: 0.75rem 0;
            font-weight: 500; /* èª¿æ•´å­—é«”ç²—ç´°ä»¥ç¬¦åˆèˆŠç‰ˆ */
            font-size: 1.2rem; /* æ”¾å¤§å­—é«” */
            border-left: 1px solid var(--border-color);
            background-color: #e9ecef; /* è¨­å®šç°è‰²èƒŒæ™¯ */
            color: var(--text-color); /* æ˜ç¢ºè¨­å®šç‚ºé»‘è‰²æ–‡å­— */
        }

        .schedule-canvas-grid {
            display: flex;
            position: relative;
            overflow-y: auto; /* å¦‚æœå…§å®¹éå¤šï¼Œå…è¨±å‚ç›´æ²å‹• */
            /* ç¸½é«˜åº¦ = å°æ™‚æ•¸ * æ¯å°æ™‚é«˜åº¦ */
            height: calc(13 * var(--hour-height)); 
        }

        .time-axis {
            width: var(--time-axis-width);
            flex-shrink: 0;
            position: relative;
        }

        .time-label {
            position: absolute;
            right: 8px;
            transform: translateY(-50%); /* è®“æ–‡å­—å‚ç›´ç½®ä¸­æ–¼ç·šä¸Š */
            font-size: 0.9rem;
            color: #6c757d;
        }

        .day-column {
            flex: 1; /* è®“æ¯å€‹æ—¥æœŸæ¬„ä½ç­‰å¯¬ */
            position: relative; /* é—œéµï¼šè¨­å®šç‚ºå­å±¤ class-item çš„å®šä½åƒè€ƒé» */
            border-left: 1px solid var(--border-color);
        }

        .hour-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: var(--hour-line-color);
            left: 0;
        }

        /* æ–°å¢ï¼šç”¨æ–¼æ–‘é¦¬ç´‹èƒŒæ™¯çš„æ¨£å¼ */
        .hour-background {
            position: absolute;
            width: 100%;
            left: 0;
            background-color: #f2f2f2; /* èˆ‡èˆŠç‰ˆè¡¨æ ¼ç›¸åŒçš„æ–‘é¦¬ç´‹é¡è‰² */
            z-index: 1; /* ç¢ºä¿èƒŒæ™¯åœ¨èª²ç¨‹å¡ç‰‡(z-index: 10)ä¹‹ä¸‹ */
            height: var(--hour-height); /* é«˜åº¦ç‚ºä¸€å°æ™‚ */
        }

        /* é€™æ˜¯æœªä¾†è¦æ”¾ç½®èª²ç¨‹çš„æ¨£å¼ï¼Œå…ˆå®šç¾©å¥½ */
        .class-item {
            position: absolute;
            left: 4px;
            right: 4px;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background-color: #404040; /* çµ±ä¸€ç‚ºæ·±ç°è‰²åº• */
            color: white;
            border-left: 5px solid var(--border-color); /* é è¨­é‚Šæ¡†ï¼Œæœƒè¢« JS è¦†è“‹ */
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9em;
            box-sizing: border-box;
            overflow: hidden;
            z-index: 10;
            transition: left 0.2s, width 0.2s; /* æ–°å¢ï¼šè®“æ’ç‰ˆè®ŠåŒ–æœ‰å‹•ç•«æ•ˆæœ */
        }

        /* æ–°å¢ï¼šæ‹–æ›³æ™‚çš„æ¨£å¼ */
        .class-item.dragging {
            opacity: 0.7;
            z-index: 20;
        }

        /* æ–°å¢ï¼šç”¨æ–¼èª¿æ•´æ™‚é•·çš„ã€ŒæŠŠæ‰‹ã€æ¨£å¼ */
        .resize-handle {
            position: absolute;
            left: 0;
            right: 0;
            height: 8px; /* æŠŠæ‰‹çš„å¯é»æ“Šé«˜åº¦ */
        }
        .resize-handle-top {
            top: 0;
            cursor: ns-resize;
        }
        .resize-handle-bottom {
            bottom: 0;
            cursor: ns-resize;
        }
        .class-item-content {
            /* ç§»é™¤ pointer-events: noneï¼Œè®“ interact.js å¯ä»¥ç›£è½åˆ° tap äº‹ä»¶ */
        }

        .class-item strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .class-item .info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            border: none;
            border-radius: 4px; 
            padding: 6px 12px; /* èˆ‡ manager.html .btn ä¸€è‡´ */
            cursor: pointer;
            color: white;
            font-size: 0.9em; /* èˆ‡ manager.html .btn ä¸€è‡´ */
            transition: background-color 0.2s;
        }
        .btn-secondary {
            background-color: #6c757d; /* èˆŠç‰ˆçš„ç°è‰² */
        }
        .btn-secondary:hover { 
            background-color: #5a6268; /* èˆŠç‰ˆçš„æ»‘é¼ æ‡¸åœé¡è‰² */
        }

        /* --- Modal å½ˆçª—æ¨£å¼ --- */
        .modal-overlay {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            border: none;
            background: none;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .modal-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* è¤‡ç”¨ manager.html çš„æŒ‰éˆ•æ¨£å¼ */
        .modal-actions .btn {
            color: white;
            border: none;
        }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }

    </style>
</head>
<body>

    <div class="schedule-container">
        <div class="schedule-controls">
            <h1>ğŸ¨ èª²è¡¨ç®¡ç† (ç•«å¸ƒç‰ˆ)</h1>
            <div>
                <button id="prev-week-btn" class="btn btn-secondary">&lt; ä¸Šä¸€é€±</button>
                <button id="next-week-btn" class="btn btn-secondary" style="margin-left: 0.5rem;">ä¸‹ä¸€é€± &gt;</button>
            </div>
        </div>
        
        <!-- æ˜ŸæœŸæ¨™é ­ -->
        <div id="schedule-header-container" class="schedule-header">
            <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
        </div>

        <!-- ä¸»è¦ç•«å¸ƒç¶²æ ¼ -->
        <div id="schedule-canvas-grid" class="schedule-canvas-grid">
            
            <!-- å·¦å´æ™‚é–“è»¸ -->
            <div id="time-axis-container" class="time-axis">
                <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
            </div>

            <!-- æ¯æ—¥ç•«å¸ƒ (7å¤©) -->
            <div id="day-columns-container" style="display: flex; flex-grow: 1;">
                <!-- JS æœƒå‹•æ…‹ç”Ÿæˆé€™è£¡çš„å…§å®¹ -->
            </div>

        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯èª²å ‚çš„ Modal (å¾ manager.html è¤‡è£½) -->
    <div id="class-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeClassModal()">&times;</button>
            <h2 id="modal-title">èª²å ‚è³‡è¨Š</h2>
            <form id="class-form">
                <input type="hidden" id="form-class-id">
                <div class="form-group">
                    <label for="form-class-date">ä¸Šèª²æ—¥æœŸ</label>
                    <input type="date" id="form-class-date" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="form-start-time">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="form-start-time" step="900" required> <!-- step="900" for 15-min intervals -->
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="form-end-time">çµæŸæ™‚é–“</label>
                        <input type="time" id="form-end-time" step="900" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="form-course-id">èª²ç¨‹å‹éŒ„</label>
                    <select id="form-course-id" required>
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="form-class-name">èª²å ‚åç¨±</label>
                    <input type="text" id="form-class-name" placeholder="ä¾‹å¦‚ï¼šç‡ƒè„‚é£›è¼ª (é€±äºŒç­)" required>
                </div>
                <div class="form-group">
                    <label for="form-coach-id">æ•™ç·´</label>
                    <select id="form-coach-id" required>
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="form-max-students">äººæ•¸ä¸Šé™</label>
                    <input type="number" id="form-max-students" min="1" value="4" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-class-btn" class="btn btn-danger">åˆªé™¤èª²å ‚</button>
                    <button type="submit" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¡ç‰‡å¼é€šçŸ¥ Modal (å¾ manager.html è¤‡è£½) -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <button id="notification-close-icon" class="modal-close-btn">&times;</button>
            <h2 id="notification-title">é€šçŸ¥</h2>
            <div class="form-group">
                <p id="notification-message" style="font-size: 1.1em; line-height: 1.6; margin: 0;"></p>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button id="notification-close-btn" class="btn">ç¢ºèª</button>
            </div>
        </div>
    </div>


    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        const startHour = 9;
        const endHour = 21;
        const hourHeight = 80; // å¿…é ˆèˆ‡ CSS ä¸­çš„ --hour-height è®Šæ•¸ä¸€è‡´
        const pixelsPerMinute = hourHeight / 60;

        let currentDate = new Date(); // ç”¨æ–¼è¿½è¹¤ç›®å‰é¡¯ç¤ºçš„é€±æ¬¡

        document.addEventListener('DOMContentLoaded', () => {
            renderCanvasShell();
            loadSchedule();

            // ç¶å®šé€±æ¬¡åˆ‡æ›æŒ‰éˆ•
            document.getElementById('prev-week-btn').addEventListener('click', () => changeWeek(-7));
            document.getElementById('next-week-btn').addEventListener('click', () => changeWeek(7));

            // --- ç¶å®š Modal ç›¸é—œäº‹ä»¶ (å¾ manager.html ç§»æ¤) ---
            document.getElementById('class-modal').addEventListener('click', (event) => {
                if (event.target === event.currentTarget) closeClassModal();
            });
            // ä¿®æ”¹ï¼šå‘¼å«å…±ç”¨å‡½å¼ï¼Œä¸¦å‚³å…¥ä¸€å€‹å›å‘¼ (callback) ä¾†é‡æ–°è¼‰å…¥èª²è¡¨
            document.getElementById('class-form').addEventListener('submit', (event) => {
                handleSaveClass(event, loadSchedule);
            });
            document.getElementById('delete-class-btn').addEventListener('click', (event) => {
                handleDeleteClass(event, loadSchedule);
            });


            // ç¶å®šèª²ç¨‹å‹éŒ„ä¸‹æ‹‰é¸å–®çš„è®Šå‹•äº‹ä»¶ï¼Œä»¥è‡ªå‹•å¡«å……èª²å ‚åç¨±
            document.getElementById('form-course-id').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const classNameInput = document.getElementById('form-class-name');
                if (selectedOption && selectedOption.value) {
                    const courseName = selectedOption.text.split(' (')[0];
                    classNameInput.value = courseName;
                } else {
                    classNameInput.value = '';
                }
            });

            // ç¶å®šé€šçŸ¥ Modal é—œé–‰äº‹ä»¶
            function closeNotificationModal() {
                document.getElementById('notification-modal').classList.remove('active');
            }
            document.getElementById('notification-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeNotificationModal();
                }
            });
            document.getElementById('notification-close-btn').addEventListener('click', closeNotificationModal);
            document.getElementById('notification-close-icon').addEventListener('click', closeNotificationModal);

            // --- ç¶å®šç•«å¸ƒé»æ“Šæ–°å¢èª²å ‚äº‹ä»¶ ---
            document.getElementById('day-columns-container').addEventListener('click', (event) => {
                // å¦‚æœé»æ“Šçš„æ˜¯å·²å­˜åœ¨çš„èª²ç¨‹ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
                if (event.target.closest('.class-item')) {
                    return;
                }

                // ç¢ºå®šé»æ“Šçš„æ˜¯æ¯æ—¥ç•«å¸ƒæ¬„ä½
                const dayColumn = event.target.closest('.day-column');
                if (dayColumn) {
                    const dayIndex = parseInt(dayColumn.dataset.day, 10);
                    const offsetY = event.offsetY;

                    handleCanvasClick(dayIndex, offsetY);
                }
            });

            // åˆå§‹åŒ–æ‹–æ›³èˆ‡ç¸®æ”¾åŠŸèƒ½
            initDragAndResize();
        });

        /**
         * æ¸²æŸ“ç•«å¸ƒçš„éœæ…‹éª¨æ¶ (æ™‚é–“è»¸ã€æ˜ŸæœŸæ¨™é ­ã€ç¶²æ ¼ç·š)
         */
        function renderCanvasShell() {
            const headerContainer = document.getElementById('schedule-header-container');
            const timeAxisContainer = document.getElementById('time-axis-container');
            const dayColumnsContainer = document.getElementById('day-columns-container');

            // --- æ¸²æŸ“å·¦å´æ™‚é–“è»¸ ---
            let timeAxisHtml = '';
            for (let hour = startHour; hour <= endHour; hour++) {
                const topPosition = (hour - startHour) * hourHeight;
                if (hour === startHour) {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px; transform: translateY(0);">${String(hour).padStart(2, '0')}:00</div>`;
                } else {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px;">${String(hour).padStart(2, '0')}:00</div>`;
                }
            }
            timeAxisContainer.innerHTML = timeAxisHtml;

            // --- æ¸²æŸ“æ¯æ—¥ç•«å¸ƒå’Œå°æ™‚æ°´å¹³ç·š ---
            let dayColumnsHtml = '';
            for (let i = 0; i < 7; i++) {
                let dayColumnContent = '';
                // è¿´åœˆç”¢ç”Ÿæ°´å¹³ç·šå’Œæ–‘é¦¬ç´‹èƒŒæ™¯
                for (let hour = startHour; hour < endHour; hour++) { // å¾ 9 é»åˆ° 20 é»
                    const topPosition = (hour - startHour) * hourHeight;
                    // ç•«å‡ºä¸‹ä¸€å°æ™‚çš„é ‚éƒ¨ç·šæ¢ (10:00, 11:00...)
                    if (hour > startHour - 1) {
                         dayColumnContent += `<div class="hour-line" style="top: ${topPosition + hourHeight}px;"></div>`;
                    }
                    // ç‚ºå¶æ•¸å°æ™‚åŠ ä¸ŠèƒŒæ™¯è‰²å¡Š (10:00, 12:00, ...)
                    if (hour % 2 === 0) {
                        dayColumnContent += `<div class="hour-background" style="top: ${topPosition}px;"></div>`;
                    }
                }
                // ç‚ºæ¯æ—¥ç•«å¸ƒåŠ ä¸Š data-day å±¬æ€§ï¼Œæ–¹ä¾¿å¾ŒçºŒé¸å–
                dayColumnsHtml += `<div class="day-column" data-day="${i}">${dayColumnContent}</div>`;
            }
            dayColumnsContainer.innerHTML = dayColumnsHtml;
        }

        /**
         * è¼‰å…¥ä¸¦æ¸²æŸ“æŒ‡å®šé€±æ¬¡çš„èª²è¡¨
         */
        async function loadSchedule() {
            const startOfWeek = new Date(currentDate);
            const dayOfWeek = startOfWeek.getDay(); // 0=Sun, 1=Mon, ...
            startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek); // å°‡ä¸€é€±é–‹å§‹è¨­ç‚ºæ˜ŸæœŸæ—¥

            const endDate = new Date(startOfWeek);
            endDate.setDate(startOfWeek.getDate() + 6);

            const formatDate = (date) => date.toISOString().split('T')[0];
            const startDateString = formatDate(startOfWeek);
            const endDateString = formatDate(endDate);

            // æ›´æ–°æ˜ŸæœŸæ¨™é ­
            updateDayHeaders(startOfWeek);

            try {
                const { data, error } = await supabaseClient
                    .from('classes_with_details')
                    .select('*')
                    .gte('class_date', startDateString)
                    .lte('class_date', endDateString);

                if (error) throw error;

                renderClasses(data);

            } catch (error) {
                console.error('è¼‰å…¥èª²è¡¨è³‡æ–™å¤±æ•—:', error);
                alert(`è¼‰å…¥èª²è¡¨å¤±æ•—: ${error.message}`);
            }
        }

        /**
         * å°‡èª²ç¨‹è³‡æ–™æ¸²æŸ“åˆ°ç•«å¸ƒä¸Š
         * @param {Array} classes - å¾ Supabase å–å¾—çš„èª²ç¨‹è³‡æ–™é™£åˆ—
         */
        function renderClasses(classes) {
            // 1. æ¸…é™¤ç•«å¸ƒä¸Šæ‰€æœ‰èˆŠçš„èª²ç¨‹é …ç›®
            document.querySelectorAll('.class-item').forEach(item => item.remove());

            // 2. é€æ—¥è™•ç†èª²ç¨‹ï¼Œä»¥è¨ˆç®—é‡ç–Šæ’ç‰ˆ
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                // 2.1. ç¯©é¸å‡ºç•¶å¤©çš„æ‰€æœ‰èª²ç¨‹ï¼Œä¸¦è½‰æ›ç‚ºåŒ…å«æ™‚é–“æˆ³çš„ç‰©ä»¶
                const dailyClasses = classes
                    .filter(cls => new Date(cls.class_date).getDay() === dayIndex)
                    .map(cls => {
                        const [startH, startM] = cls.start_time.split(':').map(Number);
                        const [endH, endM] = cls.end_time.split(':').map(Number);
                        return {
                            ...cls,
                            startMinutes: startH * 60 + startM,
                            endMinutes: endH * 60 + endM,
                            // é è¨­æ’ç‰ˆå±¬æ€§
                            layout: {
                                column: 0,
                                totalColumns: 1
                            }
                        };
                    })
                    .sort((a, b) => a.startMinutes - b.startMinutes); // æŒ‰é–‹å§‹æ™‚é–“æ’åº

                if (dailyClasses.length === 0) continue;

                // 2.2. æ‰¾å‡ºæ‰€æœ‰é‡ç–Šçš„ç¾¤çµ„
                let collisionGroups = [];
                dailyClasses.forEach(cls => {
                    let placed = false;
                    for (const group of collisionGroups) {
                        // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾¤çµ„ä¸­ä»»ä½•ä¸€å€‹èª²ç¨‹é‡ç–Š
                        if (group.some(c => cls.startMinutes < c.endMinutes && cls.endMinutes > c.startMinutes)) {
                            group.push(cls);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        collisionGroups.push([cls]);
                    }
                });

                // 2.3. ç‚ºæ¯å€‹ç¾¤çµ„è¨ˆç®—æ¬„ä½ä¸¦åˆ†é…ä½ç½®
                collisionGroups.forEach(group => {
                    group.sort((a, b) => a.startMinutes - b.startMinutes);

                    let columns = []; // ç”¨æ–¼è¿½è¹¤æ¯ä¸€æ¬„çš„çµæŸæ™‚é–“
                    group.forEach(cls => {
                        let placedInColumn = false;
                        // å°‹æ‰¾ç¬¬ä¸€å€‹å¯ç”¨çš„æ¬„ä½
                        for (let i = 0; i < columns.length; i++) {
                            if (cls.startMinutes >= columns[i]) {
                                columns[i] = cls.endMinutes;
                                cls.layout.column = i;
                                placedInColumn = true;
                                break;
                            }
                        }
                        // å¦‚æœæ²’æœ‰å¯ç”¨æ¬„ä½ï¼Œå‰‡æ–°å¢ä¸€æ¬„
                        if (!placedInColumn) {
                            columns.push(cls.endMinutes);
                            cls.layout.column = columns.length - 1;
                        }
                    });

                    // å°‡ç¾¤çµ„çš„ç¸½æ¬„æ•¸è¨­å®šçµ¦ç¾¤çµ„å…§çš„æ¯å€‹èª²ç¨‹
                    const totalColumns = columns.length;
                    group.forEach(cls => {
                        cls.layout.totalColumns = totalColumns;
                    });
                });

                // 2.4. æ¸²æŸ“ç•¶å¤©çš„æ‰€æœ‰èª²ç¨‹
                const dayColumn = document.querySelector(`.day-column[data-day="${dayIndex}"]`);
                dailyClasses.forEach(cls => {
                    const top = (cls.startMinutes - startHour * 60) * pixelsPerMinute;
                    const height = (cls.endMinutes - cls.startMinutes) * pixelsPerMinute;
                    const width = 100 / cls.layout.totalColumns;
                    const left = cls.layout.column * width;

                    const classEl = document.createElement('div');
                    classEl.className = 'class-item';
                    classEl.dataset.classId = cls.class_id;

                    classEl.style.top = `${top}px`;
                    classEl.style.height = `${height}px`;
                    classEl.style.width = `${width}%`;
                    classEl.style.left = `${left}%`;
                    classEl.style.borderLeftColor = cls.color || '#6c757d';

                    classEl.innerHTML = `
                        <div class="class-item-content">
                            <strong>${cls.class_name}</strong>
                            <div class="info">${cls.coach_name} (${cls.current_students}/${cls.max_students})</div>
                            <div class="info">${cls.start_time.substring(0, 5)} - ${cls.end_time.substring(0, 5)}</div>
                        </div>
                        <div class="resize-handle resize-handle-top"></div>
                        <div class="resize-handle resize-handle-bottom"></div>
                    `;

                    if (dayColumn) {
                        dayColumn.appendChild(classEl);
                    }
                });
            }
        }

        /**
         * æ›´æ–°æ˜ŸæœŸæ¨™é ­ä»¥é¡¯ç¤ºæ—¥æœŸ
         * @param {Date} startOfWeek - ç•¶é€±çš„æ˜ŸæœŸæ—¥
         */
        function updateDayHeaders(startOfWeek) {
            const headerContainer = document.getElementById('schedule-header-container');
            const days = ['é€±æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let headerHtml = '';
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startOfWeek);
                currentDate.setDate(startOfWeek.getDate() + i);
                headerHtml += `<div class="day-header">${days[i]}<br><span style="font-size: 0.8em; font-weight: 400;">${currentDate.getMonth() + 1}/${currentDate.getDate()}</span></div>`;
            }
            headerContainer.innerHTML = headerHtml;
        }

        /**
         * åˆ‡æ›é€±æ¬¡
         * @param {number} days - è¦ç§»å‹•çš„å¤©æ•¸ (ä¾‹å¦‚ -7 æˆ– 7)
         */
        function changeWeek(days) {
            currentDate.setDate(currentDate.getDate() + days);
            loadSchedule();
        }

        // --- Modal ç›¸é—œå‡½å¼ (å¾ manager.html ç§»æ¤ä¸¦ä¿®æ”¹) ---

        /**
         * è™•ç†åœ¨ç•«å¸ƒç©ºç™½è™•é»æ“Šçš„äº‹ä»¶
         * @param {number} dayIndex - æ˜ŸæœŸå¹¾ (0=Sun, 6=Sat)
         * @param {number} offsetY - é»æ“Šä½ç½®çš„å‚ç›´åƒç´ 
         */
        function handleCanvasClick(dayIndex, offsetY) {
            // 1. è¨ˆç®—æ—¥æœŸ
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const clickedDate = new Date(startOfWeek);
            clickedDate.setDate(clickedDate.getDate() + dayIndex);
            const dateString = clickedDate.toISOString().split('T')[0];

            // 2. è¨ˆç®—æ™‚é–“ä¸¦å°é½Šåˆ° 15 åˆ†é˜
            const totalMinutesFrom9AM = offsetY / pixelsPerMinute;
            const hourPart = Math.floor(totalMinutesFrom9AM / 60);
            const minutePart = totalMinutesFrom9AM % 60;
            
            // å°‡åˆ†é˜æ•¸å°é½Šåˆ°æœ€è¿‘çš„ 15 åˆ†é˜é–“éš”
            const snappedMinute = Math.round(minutePart / 15) * 15;

            let startH = startHour + hourPart;
            let startM = snappedMinute;

            // è™•ç†é€²ä½ï¼Œä¾‹å¦‚ 10:55 é»æ“Šå¾Œå°é½Šåˆ° 11:00
            if (startM >= 60) {
                startH += 1;
                startM = 0;
            }

            // æ ¼å¼åŒ–ç‚º HH:MM
            const startTimeString = `${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')}`;

            // 3. é–‹å•Ÿæ–°å¢ Modal
            openClassModalForNew(dateString, startTimeString);
        }

        /**
         * é–‹å•Ÿ Modal ä»¥ç·¨è¼¯ç¾æœ‰èª²å ‚
         */
        async function openClassModal(classId) {
            const modal = document.getElementById('class-modal');
            const form = document.getElementById('class-form');
            form.reset();

            // è¼‰å…¥èª²ç¨‹å’Œæ•™ç·´åˆ—è¡¨
            await loadManagerFormData();

            document.getElementById('modal-title').textContent = 'ç·¨è¼¯èª²å ‚';
            document.getElementById('delete-class-btn').style.display = 'inline-block';
            document.getElementById('form-class-id').value = classId;

            try {
                // æŸ¥è©¢ classes_with_details åŒ…å« end_time
                const { data, error } = await supabaseClient
                    .from('classes_with_details')
                    .select('*')
                    .eq('class_id', classId)
                    .single();

                if (error) throw new Error(error.message || 'æ‰¾ä¸åˆ°æŒ‡å®šçš„èª²å ‚');

                // å…ˆå¡«å……ä¸‹æ‹‰é¸å–®ï¼Œå†è¨­å®šè¡¨å–®çš„å€¼
                populateFormDropdowns(); 

                document.getElementById('form-class-date').value = data.class_date;
                document.getElementById('form-start-time').value = data.start_time.substring(0, 5);
                document.getElementById('form-end-time').value = data.end_time ? data.end_time.substring(0, 5) : '';
                document.getElementById('form-course-id').value = data.course_id;
                document.getElementById('form-class-name').value = data.class_name;
                document.getElementById('form-coach-id').value = data.coach_id;
                document.getElementById('form-max-students').value = data.max_students;

            } catch (error) {
                showNotification(`è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                return;
            }

            modal.classList.add('active');
        }

        /**
         * é–‹å•Ÿ Modal ä»¥æ–°å¢èª²å ‚
         */
        async function openClassModalForNew(date, startTime) {
            const modal = document.getElementById('class-modal');
            const form = document.getElementById('class-form');
            form.reset();

            // è¼‰å…¥èª²ç¨‹å’Œæ•™ç·´åˆ—è¡¨
            await loadManagerFormData();
            populateFormDropdowns();

            document.getElementById('modal-title').textContent = 'æ–°å¢èª²å ‚';
            document.getElementById('delete-class-btn').style.display = 'none';
            document.getElementById('form-class-id').value = ''; // ç¢ºä¿ classId ç‚ºç©º

            // å¡«å…¥å¾é»æ“Šä½ç½®è¨ˆç®—å‡ºçš„æ—¥æœŸå’Œæ™‚é–“
            document.getElementById('form-class-date').value = date;
            document.getElementById('form-start-time').value = startTime;

            // é è¨­çµæŸæ™‚é–“ç‚ºé–‹å§‹æ™‚é–“å¾Œ 60 åˆ†é˜
            const [startH, startM] = startTime.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(startH + 1, startM, 0, 0);
            const endTimeString = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
            document.getElementById('form-end-time').value = endTimeString;

            modal.classList.add('active');
        }

        // --- æ–°å¢ï¼šæ‹–æ›³èˆ‡ç¸®æ”¾ç›¸é—œå‡½å¼ ---

        function initDragAndResize() {
            const snapSize = pixelsPerMinute * 15; // 15 åˆ†é˜å°æ‡‰çš„åƒç´ é«˜åº¦

            // 1. æ‹–æ›³ç§»å‹•åŠŸèƒ½
            interact('.class-item')
                .draggable({
                    listeners: {
                        start(event) {
                            event.target.classList.add('dragging');
                        },
                        move(event) {
                            const target = event.target;
                            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                            // æ ¹æ“šç§»å‹•æ›´æ–°ä½ç½®
                            target.style.transform = `translate(${x}px, ${y}px)`;

                            // æ›´æ–° data-x å’Œ data-y å±¬æ€§
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        },
                        end(event) {
                            const target = event.target;
                            target.classList.remove('dragging');

                            const classId = target.dataset.classId;
                            const dayColumnWidth = target.parentElement.offsetWidth;

                            // è¨ˆç®—ç§»å‹•äº†å¤šå°‘å¤©å’Œå¤šå°‘åˆ†é˜
                            const dayOffset = Math.round(parseFloat(target.getAttribute('data-x')) / dayColumnWidth);
                            const rawMinuteOffset = parseFloat(target.getAttribute('data-y')) / pixelsPerMinute;
                            
                            // å¼·åˆ¶å°é½Šåˆ° 15 åˆ†é˜å–®ä½
                            const minuteOffset = Math.round(rawMinuteOffset / 15) * 15;

                            // é‡è¨­ transform å’Œ data å±¬æ€§
                            target.style.transform = '';
                            target.setAttribute('data-x', 0);
                            target.setAttribute('data-y', 0);

                            if (dayOffset === 0 && minuteOffset === 0) return;

                            updateClassByDrag(classId, dayOffset, minuteOffset);
                        }
                    },
                    modifiers: [
                        // å‚ç›´æ–¹å‘å°é½Šåˆ° 15 åˆ†é˜ç¶²æ ¼
                        interact.modifiers.snap({
                            targets: [interact.snappers.grid({ x: 1, y: snapSize })],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                    modifiers: [
                        // æ–°å¢ï¼šé™åˆ¶æ‹–æ›³ç¯„åœåœ¨çˆ¶å®¹å™¨ (æ¯æ—¥ç•«å¸ƒ) å…§
                        interact.modifiers.restrictRect({ restriction: 'parent' }),
                        // å‚ç›´æ–¹å‘å°é½Šåˆ° 15 åˆ†é˜ç¶²æ ¼
                        interact.modifiers.snap({
                            targets: [interact.snappers.grid({ x: 1, y: snapSize })],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                    inertia: true
                })
                // 3. æ–°å¢ï¼šé»æ“Š (tap) åŠŸèƒ½ï¼Œå–ä»£åŸæœ¬çš„ onclick
                .on('tap', function (event) {
                    const classId = event.currentTarget.dataset.classId;
                    if (classId) {
                        openClassModal(classId);
                    }
                    event.preventDefault();
                });

            // 2. ç¸®æ”¾èª¿æ•´æ™‚é•·åŠŸèƒ½
            interact('.class-item')
                .resizable({
                    edges: { top: '.resize-handle-top', bottom: '.resize-handle-bottom' },
                    listeners: {
                        start(event) {
                            event.target.classList.add('dragging');
                        },
                        move(event) {
                            let { x, y } = event.target.dataset;
                            x = (parseFloat(x) || 0);
                            y = (parseFloat(y) || 0);

                            // æ›´æ–°å°ºå¯¸
                            event.target.style.width = event.rect.width + 'px';
                            event.target.style.height = event.rect.height + 'px';

                            // æ›´æ–°ä½ç½®
                            x += event.deltaRect.left;
                            y += event.deltaRect.top;
                            event.target.style.transform = `translate(${x}px, ${y}px)`;

                            event.target.setAttribute('data-x', x);
                            event.target.setAttribute('data-y', y);
                        },
                        end(event) {
                            const target = event.target;
                            target.classList.remove('dragging');

                            const classId = target.dataset.classId;
                            const newTop = target.offsetTop + (parseFloat(target.getAttribute('data-y')) || 0);
                            const newHeight = target.offsetHeight;

                            // é‡è¨­ transform å’Œ data å±¬æ€§
                            target.style.transform = '';
                            target.setAttribute('data-x', 0);
                            target.setAttribute('data-y', 0);

                            updateClassByResize(classId, newTop, newHeight);
                        }
                    },
                    modifiers: [
                        // å‚ç›´æ–¹å‘å°é½Šåˆ° 15 åˆ†é˜ç¶²æ ¼
                        interact.modifiers.snap({
                            targets: [interact.snappers.grid({ y: snapSize })],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                    modifiers: [
                        // æ–°å¢ï¼šé™åˆ¶ç¸®æ”¾ç¯„åœåœ¨çˆ¶å®¹å™¨ (æ¯æ—¥ç•«å¸ƒ) å…§
                        interact.modifiers.restrictRect({ restriction: 'parent' }),
                        // å‚ç›´æ–¹å‘å°é½Šåˆ° 15 åˆ†é˜ç¶²æ ¼
                        interact.modifiers.snap({
                            targets: [interact.snappers.grid({ y: snapSize })],
                            range: Infinity,
                            relativePoints: [{ x: 0, y: 0 }]
                        })
                    ],
                    inertia: true
                });
        }

        /**
         * è™•ç†æ‹–æ›³çµæŸå¾Œçš„è³‡æ–™æ›´æ–°
         * @param {string} classId - èª²å ‚ ID
         * @param {number} dayOffset - æ—¥æœŸåç§»é‡
         * @param {number} minuteOffset - åˆ†é˜åç§»é‡
         */
        async function updateClassByDrag(classId, dayOffset, minuteOffset) {
            await quickSaveClass(classId, { dayOffset, minuteOffset });
        }

        /**
         * è™•ç†ç¸®æ”¾çµæŸå¾Œçš„è³‡æ–™æ›´æ–°
         * @param {string} classId - èª²å ‚ ID
         * @param {number} newTop - æ–°çš„é ‚éƒ¨åƒç´ ä½ç½®
         * @param {number} newHeight - æ–°çš„é«˜åº¦åƒç´ å€¼
         */
        async function updateClassByResize(classId, newTop, newHeight) {
            // å¼·åˆ¶å°‡æ–°çš„ top å’Œ height å°é½Šåˆ° 15 åˆ†é˜å–®ä½
            const rawStartMinutes = newTop / pixelsPerMinute;
            const rawDurationMinutes = newHeight / pixelsPerMinute;
            const startMinutesFrom9AM = Math.round(rawStartMinutes / 15) * 15;
            const durationMinutes = Math.max(15, Math.round(rawDurationMinutes / 15) * 15); // ç¢ºä¿èª²ç¨‹æœ€çŸ­ç‚º 15 åˆ†é˜

            await quickSaveClass(classId, { startMinutesFrom9AM, durationMinutes });
        }

        /**
         * å¿«é€Ÿå„²å­˜èª²å ‚è®Šæ›´ï¼ˆç”¨æ–¼æ‹–æ›³å’Œç¸®æ”¾ï¼‰
         * @param {string} classId - è¦æ›´æ–°çš„èª²å ‚ ID
         * @param {object} changes - åŒ…å«è®Šæ›´å…§å®¹çš„ç‰©ä»¶
         * @property {number} [changes.dayOffset] - æ—¥æœŸåç§»é‡
         * @property {number} [changes.minuteOffset] - åˆ†é˜åç§»é‡
         * @property {number} [changes.startMinutesFrom9AM] - å¾æ—©ä¸Š9é»èµ·ç®—çš„é–‹å§‹åˆ†é˜æ•¸
         * @property {number} [changes.durationMinutes] - èª²ç¨‹æŒçºŒåˆ†é˜æ•¸
         */
        async function quickSaveClass(classId, changes) {
            const { data: oldClass, error: fetchError } = await supabaseClient.from('classes_with_details').select('*').eq('class_id', classId).single();
            if (fetchError) {
                showNotification('æ‰¾ä¸åˆ°åŸå§‹èª²ç¨‹è³‡æ–™ï¼Œç„¡æ³•æ›´æ–°ã€‚', 'error');
                return;
            }

            let newDate = new Date(oldClass.class_date);
            let [startH, startM] = oldClass.start_time.split(':').map(Number);
            let [endH, endM] = oldClass.end_time.split(':').map(Number);

            if (changes.dayOffset !== undefined && changes.minuteOffset !== undefined) {
                // è™•ç†æ‹–æ›³
                newDate.setDate(newDate.getDate() + changes.dayOffset);
                const newStartTime = new Date(0, 0, 0, startH, startM + changes.minuteOffset);
                const newEndTime = new Date(0, 0, 0, endH, endM + changes.minuteOffset);
                startH = newStartTime.getHours();
                startM = newStartTime.getMinutes();
                endH = newEndTime.getHours();
                endM = newEndTime.getMinutes();
            } else if (changes.startMinutesFrom9AM !== undefined && changes.durationMinutes !== undefined) {
                // è™•ç†ç¸®æ”¾
                const newStart = new Date(0, 0, 0, startHour, changes.startMinutesFrom9AM);
                const newEnd = new Date(0, 0, 0, startHour, changes.startMinutesFrom9AM + changes.durationMinutes);
                startH = newStart.getHours();
                startM = newStart.getMinutes();
                endH = newEnd.getHours();
                endM = newEnd.getMinutes();
            }

            const formatTime = (h, m) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

            const params = {
                p_class_id: classId,
                p_class_date: newDate.toISOString().split('T')[0],
                p_start_time: formatTime(startH, startM),
                p_end_time: formatTime(endH, endM),
                p_course_id: oldClass.course_id,
                p_class_name: oldClass.class_name,
                p_coach_id: oldClass.coach_id,
                p_max_students: oldClass.max_students
            };

            try {
                const { data, error } = await supabaseClient.rpc('save_class', params);
                if (error) throw error;
                const result = data[0];
                if (result.status === 'success') {
                    // showNotification('èª²è¡¨å·²æ›´æ–°ï¼', 'success'); // æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ï¼Œæ‹–æ‹‰æˆåŠŸå¾Œä¸é¡¯ç¤ºé€šçŸ¥
                    loadSchedule(); // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ•´å€‹èª²è¡¨
                } else {
                    showNotification(result.message, 'error');
                    loadSchedule(); // å³ä½¿å¤±æ•—ä¹Ÿé‡æ–°è¼‰å…¥ï¼Œè®“å¡ç‰‡å›åˆ°åŸä½
                }
            } catch (error) {
                showNotification(`æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
                loadSchedule(); // ç™¼ç”Ÿåš´é‡éŒ¯èª¤æ™‚ä¹Ÿé‡æ–°è¼‰å…¥
            }
        }

    </script>

</body>
</html>