<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課表管理 (新版)</title>
    <!-- 載入共用設定檔 -->
    <script src="config.js"></script>
    <!-- 載入 Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #dee2e6;
            --hour-line-color: #e9ecef;
            --time-axis-width: 80px;
            --header-height: 60px;
            --hour-height: 80px; /* 每小時的高度，可以調整 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .schedule-container {
            padding: 2rem;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .schedule-controls h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .schedule-header {
            display: flex;
            margin-left: var(--time-axis-width); /* 與下方時間軸對齊 */
            border-bottom: 2px solid var(--border-color);
        }

        .day-header {
            flex: 1; /* 讓每個日期頭部等寬 */
            text-align: center;
            padding: 0.75rem 0;
            font-weight: 600;
            font-size: 1.1rem;
            border-left: 1px solid var(--border-color);
        }

        .schedule-canvas-grid {
            display: flex;
            position: relative;
            overflow-y: auto; /* 如果內容過多，允許垂直捲動 */
            /* 總高度 = 小時數 * 每小時高度 */
            height: calc(13 * var(--hour-height)); 
        }

        .time-axis {
            width: var(--time-axis-width);
            flex-shrink: 0;
            position: relative;
        }

        .time-label {
            position: absolute;
            right: 8px;
            transform: translateY(-50%); /* 讓文字垂直置中於線上 */
            font-size: 0.9rem;
            color: #6c757d;
        }

        .day-column {
            flex: 1; /* 讓每個日期欄位等寬 */
            position: relative; /* 關鍵：設定為子層 class-item 的定位參考點 */
            border-left: 1px solid var(--border-color);
        }

        .hour-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: var(--hour-line-color);
            left: 0;
        }

        /* 這是未來要放置課程的樣式，先定義好 */
        .class-item {
            position: absolute;
            left: 4px;
            right: 4px;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background-color: #404040; /* 統一為深灰色底 */
            color: white;
            border-left: 5px solid var(--border-color); /* 預設邊框，會被 JS 覆蓋 */
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.9em;
            box-sizing: border-box;
            overflow: hidden;
            z-index: 10;
        }

        .class-item strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .class-item .info {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .student-count {
            position: absolute;
            bottom: 0.5rem; /* 與 padding 相同 */
            right: 0.5rem;  /* 與 padding 相同 */
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* 按鈕樣式 */
        .btn {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            background-color: white;
            color: var(--text-color);
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #e9ecef;
        }

        /* --- Modal 彈窗樣式 --- */
        .modal-overlay {
            display: none; /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            border: none;
            background: none;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .modal-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* 複用 manager.html 的按鈕樣式 */
        .modal-actions .btn {
            color: white;
            border: none;
        }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }

    </style>
</head>
<body>

    <div class="schedule-container">
        <div class="schedule-controls">
            <h1>🗓️ 課表管理 (畫布版)</h1>
            <div>
                <button id="prev-week-btn" class="btn">&lt; 上一週</button>
                <span id="week-range-display" style="margin: 0 1rem; font-weight: 500;"></span>
                <button id="next-week-btn" class="btn">下一週 &gt;</button>
            </div>
        </div>
        
        <!-- 星期標頭 -->
        <div id="schedule-header-container" class="schedule-header">
            <!-- JS 會動態生成這裡的內容 -->
        </div>

        <!-- 主要畫布網格 -->
        <div id="schedule-canvas-grid" class="schedule-canvas-grid">
            
            <!-- 左側時間軸 -->
            <div id="time-axis-container" class="time-axis">
                <!-- JS 會動態生成這裡的內容 -->
            </div>

            <!-- 每日畫布 (7天) -->
            <div id="day-columns-container" style="display: flex; flex-grow: 1;">
                <!-- JS 會動態生成這裡的內容 -->
            </div>

        </div>
    </div>

    <!-- 新增/編輯課堂的 Modal (從 manager.html 複製) -->
    <div id="class-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeClassModal()">&times;</button>
            <h2 id="modal-title">課堂資訊</h2>
            <form id="class-form">
                <input type="hidden" id="form-class-id">
                <div class="form-group">
                    <label for="form-class-date">上課日期</label>
                    <input type="date" id="form-class-date" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="form-start-time">開始時間</label>
                        <input type="time" id="form-start-time" step="900" required> <!-- step="900" for 15-min intervals -->
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="form-end-time">結束時間</label>
                        <input type="time" id="form-end-time" step="900" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="form-course-id">課程型錄</label>
                    <select id="form-course-id" required>
                        <option value="">載入中...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="form-class-name">課堂名稱</label>
                    <input type="text" id="form-class-name" placeholder="例如：燃脂飛輪 (週二班)" required>
                </div>
                <div class="form-group">
                    <label for="form-coach-id">教練</label>
                    <select id="form-coach-id" required>
                        <option value="">載入中...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="form-max-students">人數上限</label>
                    <input type="number" id="form-max-students" min="1" value="4" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-class-btn" class="btn btn-danger">刪除課堂</button>
                    <button type="submit" class="btn btn-success">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 卡片式通知 Modal (從 manager.html 複製) -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <button id="notification-close-icon" class="modal-close-btn">&times;</button>
            <h2 id="notification-title">通知</h2>
            <div class="form-group">
                <p id="notification-message" style="font-size: 1.1em; line-height: 1.6; margin: 0;"></p>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button id="notification-close-btn" class="btn">確認</button>
            </div>
        </div>
    </div>


    <script>
        // --- 從 config.js 讀取設定 ---
        const { createClient } = supabase;
        const supabaseClient = createClient(AppConfig.SUPABASE_URL, AppConfig.SUPABASE_ANON_KEY);

        // --- 全域變數 ---
        const startHour = 9;
        const endHour = 21;
        const hourHeight = 80; // 必須與 CSS 中的 --hour-height 變數一致
        const pixelsPerMinute = hourHeight / 60;

        let currentDate = new Date(); // 用於追蹤目前顯示的週次
        let managerFormData = null; // 儲存課程和教練列表

        document.addEventListener('DOMContentLoaded', () => {
            renderCanvasShell();
            loadSchedule();

            // 綁定週次切換按鈕
            document.getElementById('prev-week-btn').addEventListener('click', () => changeWeek(-7));
            document.getElementById('next-week-btn').addEventListener('click', () => changeWeek(7));

            // --- 綁定 Modal 相關事件 (從 manager.html 移植) ---
            document.getElementById('class-modal').addEventListener('click', (event) => {
                if (event.target === event.currentTarget) closeClassModal();
            });
            document.getElementById('class-form').addEventListener('submit', handleSaveClass);
            document.getElementById('delete-class-btn').addEventListener('click', handleDeleteClass);

            // 綁定課程型錄下拉選單的變動事件，以自動填充課堂名稱
            document.getElementById('form-course-id').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const classNameInput = document.getElementById('form-class-name');
                if (selectedOption && selectedOption.value) {
                    const courseName = selectedOption.text.split(' (')[0];
                    classNameInput.value = courseName;
                } else {
                    classNameInput.value = '';
                }
            });

            // 綁定通知 Modal 關閉事件
            function closeNotificationModal() {
                document.getElementById('notification-modal').classList.remove('active');
            }
            document.getElementById('notification-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeNotificationModal();
                }
            });
            document.getElementById('notification-close-btn').addEventListener('click', closeNotificationModal);
            document.getElementById('notification-close-icon').addEventListener('click', closeNotificationModal);
        });

        /**
         * 渲染畫布的靜態骨架 (時間軸、星期標頭、網格線)
         */
        function renderCanvasShell() {
            const headerContainer = document.getElementById('schedule-header-container');
            const timeAxisContainer = document.getElementById('time-axis-container');
            const dayColumnsContainer = document.getElementById('day-columns-container');

            // --- 渲染左側時間軸 ---
            let timeAxisHtml = '';
            for (let hour = startHour; hour <= endHour; hour++) {
                const topPosition = (hour - startHour) * hourHeight;
                if (hour === startHour) {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px; transform: translateY(0);">${String(hour).padStart(2, '0')}:00</div>`;
                } else {
                    timeAxisHtml += `<div class="time-label" style="top: ${topPosition}px;">${String(hour).padStart(2, '0')}:00</div>`;
                }
            }
            timeAxisContainer.innerHTML = timeAxisHtml;

            // --- 渲染每日畫布和小時水平線 ---
            let dayColumnsHtml = '';
            for (let i = 0; i < 7; i++) {
                let dayColumnContent = '';
                for (let hour = startHour + 1; hour <= endHour; hour++) {
                    const topPosition = (hour - startHour) * hourHeight;
                    dayColumnContent += `<div class="hour-line" style="top: ${topPosition}px;"></div>`;
                }
                // 為每日畫布加上 data-day 屬性，方便後續選取
                dayColumnsHtml += `<div class="day-column" data-day="${i}">${dayColumnContent}</div>`;
            }
            dayColumnsContainer.innerHTML = dayColumnsHtml;
        }

        /**
         * 載入並渲染指定週次的課表
         */
        async function loadSchedule() {
            const startOfWeek = new Date(currentDate);
            const dayOfWeek = startOfWeek.getDay(); // 0=Sun, 1=Mon, ...
            startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek); // 將一週開始設為星期日

            const endDate = new Date(startOfWeek);
            endDate.setDate(startOfWeek.getDate() + 6);

            const formatDate = (date) => date.toISOString().split('T')[0];
            const startDateString = formatDate(startOfWeek);
            const endDateString = formatDate(endDate);

            // 更新頂部的日期範圍顯示
            document.getElementById('week-range-display').textContent = `${startDateString} ~ ${endDateString}`;

            // 更新星期標頭
            updateDayHeaders(startOfWeek);

            try {
                const { data, error } = await supabaseClient
                    .from('classes_with_details')
                    .select('*')
                    .gte('class_date', startDateString)
                    .lte('class_date', endDateString);

                if (error) throw error;

                renderClasses(data);

            } catch (error) {
                console.error('載入課表資料失敗:', error);
                alert(`載入課表失敗: ${error.message}`);
            }
        }

        /**
         * 將課程資料渲染到畫布上
         * @param {Array} classes - 從 Supabase 取得的課程資料陣列
         */
        function renderClasses(classes) {
            // 1. 清除所有舊的課程項目
            document.querySelectorAll('.class-item').forEach(item => item.remove());

            // 2. 遍歷新課程並渲染
            classes.forEach(cls => {
                if (!cls.start_time || !cls.end_time) {
                    console.warn('課程資料缺少 start_time 或 end_time:', cls);
                    return; // 跳過不完整的資料
                }

                const classDate = new Date(cls.class_date);
                const dayIndex = classDate.getDay(); // 0=Sun, 6=Sat

                // 計算 top
                const [startH, startM] = cls.start_time.split(':').map(Number);
                const totalStartMinutesFrom9AM = (startH - startHour) * 60 + startM;
                const top = totalStartMinutesFrom9AM * pixelsPerMinute;

                // 計算 height
                const [endH, endM] = cls.end_time.split(':').map(Number);
                const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
                const height = durationMinutes * pixelsPerMinute;

                // 建立課程 DOM 元素
                const classEl = document.createElement('div');
                classEl.className = 'class-item';
                classEl.dataset.classId = cls.class_id; // 儲存 class_id 以便點擊時使用
                classEl.onclick = () => openClassModal(cls.class_id); // 綁定點擊事件

                classEl.style.top = `${top}px`;
                classEl.style.height = `${height}px`;
                // 直接使用課程型錄的顏色作為左側邊框顏色
                classEl.style.borderLeftColor = cls.color || '#6c757d';

                classEl.innerHTML = `
                    <strong>${cls.class_name}</strong>
                    <div class="info">${cls.coach_name}</div>
                    <div class="info">${cls.start_time.substring(0, 5)} - ${cls.end_time.substring(0, 5)}</div>
                    <div class="student-count">(${cls.current_students}/${cls.max_students})</div>
                `;

                // 找到對應的每日畫布並附加課程
                const dayColumn = document.querySelector(`.day-column[data-day="${dayIndex}"]`);
                if (dayColumn) {
                    dayColumn.appendChild(classEl);
                }
            });
        }

        /**
         * 更新星期標頭以顯示日期
         * @param {Date} startOfWeek - 當週的星期日
         */
        function updateDayHeaders(startOfWeek) {
            const headerContainer = document.getElementById('schedule-header-container');
            const days = ['週日', '一', '二', '三', '四', '五', '六'];
            let headerHtml = '';
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startOfWeek);
                currentDate.setDate(startOfWeek.getDate() + i);
                headerHtml += `<div class="day-header">${days[i]}<br><span style="font-size: 0.8em; font-weight: 400;">${currentDate.getMonth() + 1}/${currentDate.getDate()}</span></div>`;
            }
            headerContainer.innerHTML = headerHtml;
        }

        /**
         * 切換週次
         * @param {number} days - 要移動的天數 (例如 -7 或 7)
         */
        function changeWeek(days) {
            currentDate.setDate(currentDate.getDate() + days);
            loadSchedule();
        }

        // --- Modal 相關函式 (從 manager.html 移植並修改) ---

        async function openClassModal(classId) {
            const modal = document.getElementById('class-modal');
            const form = document.getElementById('class-form');
            form.reset();

            // 載入課程和教練列表
            await loadManagerFormData();

            document.getElementById('modal-title').textContent = '編輯課堂';
            document.getElementById('delete-class-btn').style.display = 'inline-block';
            document.getElementById('form-class-id').value = classId;

            try {
                // 查詢 classes_with_details 包含 end_time
                const { data, error } = await supabaseClient
                    .from('classes_with_details')
                    .select('*')
                    .eq('class_id', classId)
                    .single();

                if (error) throw new Error(error.message || '找不到指定的課堂');

                // 先填充下拉選單，再設定表單的值
                populateFormDropdowns(); 

                document.getElementById('form-class-date').value = data.class_date;
                document.getElementById('form-start-time').value = data.start_time.substring(0, 5);
                document.getElementById('form-end-time').value = data.end_time ? data.end_time.substring(0, 5) : '';
                document.getElementById('form-course-id').value = data.course_id;
                document.getElementById('form-class-name').value = data.class_name;
                document.getElementById('form-coach-id').value = data.coach_id;
                document.getElementById('form-max-students').value = data.max_students;

            } catch (error) {
                showNotification(`載入課堂資料失敗: ${error.message}`, 'error');
                return;
            }

            modal.classList.add('active');
        }

        function closeClassModal() {
            document.getElementById('class-modal').classList.remove('active');
        }

        async function handleSaveClass(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '儲存中...';

            const params = {
                p_class_id: document.getElementById('form-class-id').value,
                p_class_date: document.getElementById('form-class-date').value,
                p_start_time: document.getElementById('form-start-time').value,
                p_end_time: document.getElementById('form-end-time').value,
                p_course_id: document.getElementById('form-course-id').value,
                p_class_name: document.getElementById('form-class-name').value,
                p_coach_id: document.getElementById('form-coach-id').value,
                p_max_students: parseInt(document.getElementById('form-max-students').value, 10)
            };

            try {
                const { data, error } = await supabaseClient.rpc('save_class', params);
                if (error) throw error;

                const result = data[0];
                showNotification(result.message, result.status);

                if (result.status === 'success') {
                    closeClassModal();
                    loadSchedule(); // 重新載入課表
                }

            } catch (error) {
                console.error('儲存課堂時發生錯誤:', error);
                showNotification('操作失敗，請檢查網路或聯繫開發者。', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }

        async function handleDeleteClass() {
            const classId = document.getElementById('form-class-id').value;
            if (!confirm(`您確定要刪除這個課堂嗎？\n此操作無法復原。`)) return;

            const deleteBtn = document.getElementById('delete-class-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = '刪除中...';

            try {
                const { data, error } = await supabaseClient.rpc('delete_class', { p_class_id: classId });
                if (error) throw error;

                const result = data[0];
                showNotification(result.message, result.status);

                if (result.status === 'success') {
                    closeClassModal();
                    loadSchedule(); // 重新載入課表
                }
            } catch (error) {
                console.error('刪除課堂時發生錯誤:', error);
                showNotification('操作失敗，請檢查網路或聯繫開發者。', 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = '刪除課堂';
            }
        }

        async function loadManagerFormData() {
            if (managerFormData) return; // 如果資料已存在，直接返回
            try {
                const { data: result, error } = await supabaseClient.rpc('get_manager_form_data');
                if (error) throw error;
                managerFormData = result;
            } catch (error) {
                console.error('載入管理表單資料失敗:', error);
                showNotification(`載入表單選項失敗: ${error.message}`, 'error');
            }
        }

        function populateFormDropdowns() {
            if (!managerFormData) return;

            const courseSelect = document.getElementById('form-course-id');
            const coachSelect = document.getElementById('form-coach-id');

            courseSelect.innerHTML = '<option value="">-- 請選擇課程 --</option>';
            managerFormData.courses.forEach(course => {
                const option = new Option(`${course.courseName} (${course.courseId})`, course.courseId);
                courseSelect.add(option);
            });

            coachSelect.innerHTML = '<option value="">-- 請選擇教練 --</option>';
            managerFormData.coaches.forEach(coach => {
                const option = new Option(coach.coachName, coach.coachId);
                coachSelect.add(option);
            });
        }

        function showNotification(message, type = 'info') {
            const modal = document.getElementById('notification-modal');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            const closeBtn = document.getElementById('notification-close-btn');

            messageEl.textContent = message;
            closeBtn.className = 'btn'; // 重設按鈕 class

            switch (type) {
                case 'success':
                    titleEl.textContent = '操作成功';
                    closeBtn.classList.add('btn-success');
                    break;
                case 'error':
                    titleEl.textContent = '發生錯誤';
                    closeBtn.classList.add('btn-danger');
                    break;
                default:
                    titleEl.textContent = '通知';
                    closeBtn.classList.add('btn-secondary');
                    break;
            }
            modal.classList.add('active');
        }

    </script>

</body>
</html>